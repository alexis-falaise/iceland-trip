<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <title>Iceland Epic üáÆüá∏</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap");

    :root {
      --background: 210 40% 98%;
      --foreground: 222.2 47.4% 11.2%;
      --card: 0 0% 100%;
      --muted: 210 40% 96.1%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --border: 214.3 31.8% 91.4%;
      --ring: 215 20.2% 65.1%;
      --primary: 221.2 83.2% 53.3%;
      --primary-foreground: 210 40% 98%;
      --success: 142 76% 36%;
      --radius: 16px;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);

      --day-1: #0b3d91;
      --day-2: #f59e0b;
      --day-3: #38bdf8;
      --day-4: #9ca3af;
      --day-5: #b45309;
      --day-6: #7f1d1d;
      --day-7: #14b8a6;
      --day-8: #5b21b6;
      --day-9: #166534;
      --day-10: #fb7185;
      --day-11: #f472b6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Manrope", "Segoe UI", sans-serif;
      color: hsl(var(--foreground));
      background:
        radial-gradient(circle at 20% -10%, rgba(59, 130, 246, 0.18), transparent 36%),
        radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.12), transparent 30%),
        hsl(var(--background));
      min-height: 100vh;
      line-height: 1.45;
      padding-bottom: 40px;
    }

    body.modal-open {
      overflow: hidden;
    }

    .day-card {
      border: 1px solid hsl(var(--border));
      border-left: 6px solid var(--day-color);
      border-radius: var(--radius);
      background: white;
      margin-bottom: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .day-card summary {
      list-style: none;
      cursor: pointer;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(90deg, color-mix(in srgb, var(--day-color) 18%, white), white 65%);
    }

    .day-card summary::-webkit-details-marker {
      display: none;
    }

    .fullscreen-trigger {
      background: var(--day-color);
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 6px 14px color-mix(in srgb, var(--day-color) 35%, transparent);
    }

    .fullscreen-trigger:hover {
      background: color-mix(in srgb, var(--day-color) 80%, black);
      color: #ffffff;
    }

    .day-heading {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .day-number {
      font-size: 0.74rem;
      font-weight: 800;
      color: white;
      background: var(--day-color);
      border-radius: 999px;
      padding: 4px 9px;
      white-space: nowrap;
    }

    .day-title {
      font-weight: 800;
      font-size: 0.96rem;
      line-height: 1.25;
    }

    .day-content {
      border-top: 1px solid hsl(var(--border));
      padding: 14px;
      font-size: 0.93rem;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 11px;
    }

    .tag {
      border: 1px solid hsl(var(--border));
      border-radius: 999px;
      padding: 4px 10px;
      background: hsl(var(--muted));
      font-size: 0.8rem;
      font-weight: 700;
      color: hsl(var(--muted-foreground));
    }

    .map-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 800;
      font-size: 0.9rem;
    }

    .map-link:hover {
      text-decoration: underline;
    }

    .day-content h4,
    .fullscreen-card h4 {
      margin: 8px 0 6px;
      font-size: 0.88rem;
      color: hsl(var(--muted-foreground));
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .day-content ul {
      padding-left: 20px;
      margin-bottom: 8px;
    }

    .day-content li {
      margin: 4px 0;
    }

    .fullscreen-modal {
      position: fixed;
      inset: 0;
      z-index: 999;
      background: rgba(2, 6, 23, 0.72);
      display: none;
      padding: 0;
    }

    .fullscreen-modal.open {
      display: block;
    }

    .fullscreen-panel {
      width: 100%;
      height: 100dvh;
      background: white;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .fullscreen-head {
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .fullscreen-title {
      font-size: 1.05rem;
      font-weight: 800;
      line-height: 1.3;
    }

    .fullscreen-body {
      overflow-y: auto;
      padding: 14px;
      background: hsl(var(--background));
    }

    .fullscreen-card {
      background: white;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 12px;
    }

    .map-embed {
      width: 100%;
      min-height: 280px;
      border: 1px solid hsl(var(--border));
      border-radius: 12px;
      margin-bottom: 10px;
      background: hsl(var(--muted));
      overflow: hidden;
    }

    .route-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .route-stop {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--muted));
      border-radius: 999px;
      font-size: 0.77rem;
      font-weight: 700;
      color: hsl(var(--muted-foreground));
    }

    .route-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--route-color, #1d4ed8);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.95);
    }

    .itinerary-list {
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }

    .itinerary-item {
      display: grid;
      grid-template-columns: 20px 1fr;
      gap: 12px;
      align-items: start;
    }

    .itinerary-rail {
      position: relative;
      display: flex;
      justify-content: center;
      width: 20px;
      min-height: 40px;
    }

    .itinerary-rail::before {
      content: "";
      position: absolute;
      top: 8px;
      bottom: -14px;
      width: 2px;
      background: hsl(var(--border));
    }

    .itinerary-item:last-child .itinerary-rail::before {
      display: none;
    }

    .itinerary-dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: var(--itinerary-color, #1d4ed8);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 1);
      margin-top: 2px;
      z-index: 1;
    }

    .location-card {
      border: 1px solid hsl(var(--border));
      border-radius: 12px;
      padding: 10px;
      background: white;
    }

    .location-name {
      font-size: 0.97rem;
      font-weight: 800;
      margin-bottom: 3px;
    }

    .location-note {
      font-size: 0.86rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 8px;
    }

    .location-image {
      display: block;
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--muted));
    }

    .recommendation-list {
      display: grid;
      gap: 10px;
      margin-top: 8px;
    }

    .recommendation-item {
      border: 1px solid hsl(var(--border));
      border-radius: 12px;
      padding: 10px;
      background: white;
    }

    .recommendation-item h5 {
      font-size: 0.92rem;
      margin-bottom: 5px;
      font-weight: 800;
    }

    .recommendation-item p {
      font-size: 0.86rem;
      color: hsl(var(--muted-foreground));
    }

    .muted {
      color: hsl(var(--muted-foreground));
      font-size: 0.88rem;
    }

    /* Index-style visual override */
    :root {
      --bg: #fafafa;
      --card-ui: #ffffff;
      --border-ui: #e4e4e7;
      --text-ui: #09090b;
      --muted-ui: #f4f4f5;
      --muted-text-ui: #71717a;
      --success-ui: #16a34a;
      --radius-ui: 10px;
      --tab-bar-safe-height: 112px;
      --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text-ui);
      line-height: 1.5;
      padding-bottom: calc(var(--tab-bar-safe-height) + env(safe-area-inset-bottom, 0px));
    }

    .shell {
      max-width: 640px;
      width: 100%;
      margin: 0 auto;
      padding: 14px;
    }

    .app-header {
      background: linear-gradient(155deg, #0f2040 0%, #1e3a5f 100%);
      color: #fff;
      padding: 52px 20px 22px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      width: 100%;
      border: none;
      border-radius: 0;
      box-shadow: none;
      backdrop-filter: none;
      margin-bottom: 0;
      transition: height 0.24s ease, padding 0.24s ease, background 0.24s ease;
      overflow: hidden;
      isolation: isolate;
    }

    .app-header.home-hero {
      min-height: 230px;
      padding: 54px 16px 18px;
    }

    .header-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: 50% 42%;
      z-index: 0;
      transform: scale(1.08);
      filter: saturate(1.3) contrast(1.12) brightness(0.84);
      pointer-events: none;
    }

    .header-video-overlay {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      background:
        linear-gradient(160deg, rgba(10, 25, 47, 0.44) 0%, rgba(22, 40, 63, 0.66) 100%),
        radial-gradient(circle at 82% -10%, rgba(98, 255, 245, 0.24), transparent 42%),
        radial-gradient(circle at 18% 8%, rgba(244, 114, 182, 0.14), transparent 34%);
    }

    .header-content {
      position: relative;
      z-index: 2;
      color: rgba(247, 250, 252, 0.97);
    }

    .app-header.home-hero .header-content {
      max-width: 640px;
      margin: 0 auto;
    }

    .header-title-text {
      color: rgba(247, 250, 252, 0.95);
    }

    .app-header h1 {
      font-size: 1.55rem;
      font-weight: 700;
      letter-spacing: -0.3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      line-height: 1;
      transition: font-size 0.2s ease;
    }

    .app-header .header-flag {
      display: inline-flex;
      line-height: 1;
    }

    .app-header .dates {
      font-size: 0.83rem;
      color: rgba(255, 255, 255, 0.72);
      margin-top: 5px;
      transition: font-size 0.2s ease, margin-top 0.2s ease;
    }

    .app-header .couple {
      font-size: 0.82rem;
      color: rgba(255, 255, 255, 0.55);
      margin-top: 2px;
      transition: opacity 0.18s ease, margin-top 0.18s ease;
    }

    .app-header.compact {
      height: 32px;
      min-height: 32px;
      padding: 0 12px;
      background: linear-gradient(155deg, #10264b 0%, #1e3a5f 100%);
    }

    .app-header.compact .header-content {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      text-align: left;
    }

    .app-header.compact h1 {
      font-size: 0.95rem;
      margin: 0;
      gap: 0;
    }

    .app-header.compact .header-title-text {
      display: none;
    }

    .app-header.compact .dates {
      margin-top: 0;
      font-size: 0.72rem;
      line-height: 1;
    }

    .app-header.compact .couple {
      display: none;
    }

    .app-header.compact #departure-countdown-card {
      display: none !important;
    }

    .card {
      background: var(--card-ui);
      border: 1px solid var(--border-ui);
      border-radius: var(--radius-ui);
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }

    .countdown-card {
      text-align: center;
      padding: 16px;
    }

    #departure-countdown-card {
      position: relative;
      z-index: 2;
      width: min(560px, calc(100% - 8px));
      margin: 14px auto 0;
      background: rgba(255, 255, 255, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.34);
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(7, 14, 26, 0.26);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
      color: #f8fafc;
    }

    .countdown-days {
      font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.05;
      color: #ffffff;
    }

    .countdown-sub {
      margin-top: 5px;
      font-size: 0.9rem;
      color: rgba(241, 245, 249, 0.94);
      font-weight: 600;
    }

    .countdown-caption {
      margin-top: 7px;
      font-size: 0.76rem;
      color: rgba(226, 232, 240, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    #packing-card {
      background: var(--card-ui);
      border: 1px solid var(--border-ui);
      border-radius: var(--radius-ui);
      padding: 14px 16px;
    }

    .card-title {
      font-size: 0.83rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    #packing-card .card-title {
      font-size: 0.83rem;
      margin-bottom: 12px;
      letter-spacing: 0.01em;
    }

    .flight-block {
      padding: 9px 0;
    }

    .flight-block + .flight-block {
      border-top: 1px solid var(--border-ui);
    }

    #flight-card.outbound-hidden .flight-block.return-flight-block {
      border-top: none;
      padding-top: 0;
    }

    .flight-badge {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted-text-ui);
      margin-bottom: 3px;
    }

    .flight-route {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .flight-ref {
      font-size: 0.76rem;
      color: var(--muted-text-ui);
      margin-top: 2px;
    }

    .section-title {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted-text-ui);
      margin: 11px 0 6px;
    }

    .tab-shell {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1800;
      display: flex;
      justify-content: center;
      padding: 8px 12px calc(10px + env(safe-area-inset-bottom, 0px));
      pointer-events: none;
    }

    .tab-bar {
      width: min(680px, 100%);
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.66), rgba(255, 255, 255, 0.34));
      border: 1px solid rgba(255, 255, 255, 0.66);
      border-radius: 20px;
      box-shadow:
        0 14px 32px rgba(9, 9, 11, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.75),
        inset 0 -1px 0 rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(24px) saturate(1.2);
      -webkit-backdrop-filter: blur(24px) saturate(1.2);
      padding: 7px 8px;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      pointer-events: auto;
    }

    .tab-bar::before {
      content: "";
      position: absolute;
      left: 8px;
      right: 8px;
      top: 5px;
      height: 38%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.52), rgba(255, 255, 255, 0));
      pointer-events: none;
      z-index: 0;
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: rgba(63, 63, 70, 0.85);
      border-radius: 14px;
      padding: 7px 8px;
      display: grid;
      justify-items: center;
      gap: 3px;
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
      font-family: var(--font-ui);
      min-height: 52px;
      position: relative;
      z-index: 1;
      -webkit-tap-highlight-color: transparent;
    }

    .tab-btn::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: 13px;
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.55));
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow:
        0 6px 16px rgba(148, 163, 184, 0.34),
        inset 0 1px 0 rgba(255, 255, 255, 0.95),
        inset 0 -1px 0 rgba(148, 163, 184, 0.2);
      opacity: 0;
      transform: scale(0.92);
      transition: opacity 0.22s ease, transform 0.22s ease;
      z-index: -1;
    }

    .tab-btn:hover {
      color: #111827;
      transform: translateY(-1px);
    }

    .tab-btn:hover::before {
      opacity: 0.46;
      transform: scale(0.98);
    }

    .tab-btn.active {
      color: #0f172a;
      transform: translateY(-1px);
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.55);
    }

    .tab-btn.active::before {
      opacity: 1;
      transform: scale(1);
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(241, 245, 249, 0.76));
      border-color: rgba(255, 255, 255, 0.95);
      box-shadow:
        0 9px 20px rgba(148, 163, 184, 0.42),
        inset 0 1px 0 rgba(255, 255, 255, 0.98),
        inset 0 -1px 0 rgba(148, 163, 184, 0.24);
    }

    .tab-btn:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.75);
      outline-offset: 2px;
    }

    .tab-icon {
      width: 19px;
      height: 19px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .tab-icon svg {
      width: 100%;
      height: 100%;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.9;
      stroke-linecap: round;
      stroke-linejoin: round;
      vector-effect: non-scaling-stroke;
    }

    .tab-label {
      font-size: 0.67rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      line-height: 1;
    }

    .prog-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.72rem;
      color: var(--muted-text-ui);
      margin-bottom: 5px;
    }

    .prog-bar {
      height: 5px;
      background: var(--muted-ui);
      border-radius: 100px;
      overflow: hidden;
      margin-bottom: 13px;
    }

    .prog-fill {
      height: 100%;
      background: var(--success-ui);
      border-radius: 100px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .add-row {
      display: flex;
      gap: 7px;
      margin-bottom: 11px;
    }

    .text-input {
      flex: 1;
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      padding: 7px 11px;
      font-size: 0.875rem;
      font-family: var(--font-ui);
      background: var(--bg);
      color: var(--text-ui);
      min-width: 0;
      outline: none;
      transition: border-color 0.15s;
    }

    .text-input:focus {
      border-color: #a1a1aa;
    }

    .btn {
      border: 1px solid var(--border-ui);
      background: #fff;
      color: var(--muted-text-ui);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.78rem;
      font-weight: 500;
      transform: none;
      transition: color 0.15s, background 0.15s, border-color 0.15s, opacity 0.15s;
    }

    .btn:hover {
      transform: none;
      background: var(--muted-ui);
      color: var(--text-ui);
    }

    .btn-primary {
      border: none;
      background: var(--text-ui);
      color: var(--card-ui);
      padding: 7px 14px;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      font-family: var(--font-ui);
      white-space: nowrap;
    }

    .btn-primary:hover {
      background: var(--text-ui);
      opacity: 0.82;
    }

    .btn-danger {
      color: #dc2626;
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.2);
      color: #ffffff;
      border-color: rgba(255, 255, 255, 0.35);
      padding: 8px 10px;
      font-size: 0.8rem;
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    #packlist {
      display: block;
      background: #ffffff;
    }

    #budget-card {
      background: var(--card-ui);
      border: 1px solid var(--border-ui);
      border-radius: var(--radius-ui);
      padding: 14px 16px;
    }

    .budget-summary {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.74rem;
      color: var(--muted-text-ui);
      margin-bottom: 6px;
    }

    .budget-main {
      color: var(--text-ui);
      font-weight: 600;
      font-size: 0.82rem;
    }

    .budget-main.over {
      color: #b91c1c;
    }

    .budget-percent {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--muted-text-ui);
      white-space: nowrap;
    }

    .budget-percent.over {
      color: #b91c1c;
    }

    .budget-rate {
      font-size: 0.7rem;
      color: var(--muted-text-ui);
      margin: -1px 0 10px;
    }

    .budget-rate.stale {
      opacity: 0.78;
    }

    .budget-rate.loading {
      font-style: italic;
    }

    .budget-form {
      display: grid;
      gap: 7px;
      margin-bottom: 9px;
    }

    #budget-max-form {
      grid-template-columns: minmax(0, 1fr) auto;
    }

    #expense-form {
      grid-template-columns: minmax(0, 1fr) minmax(0, 150px) auto;
    }

    .budget-calc .budget-form {
      grid-template-columns: minmax(0, 1fr) auto;
    }

    .budget-amount-input {
      width: 100%;
      max-width: none;
      min-width: 0;
    }

    #budget-list {
      display: block;
      background: #ffffff;
      margin-top: 4px;
    }

    .expense-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 0;
      border-bottom: 1px solid var(--border-ui);
    }

    .expense-item:last-child {
      border-bottom: none;
    }

    .expense-item.base-expense {
      background: color-mix(in srgb, var(--muted-ui) 45%, #ffffff);
    }

    .expense-main-wrap {
      flex: 1;
      min-width: 0;
    }

    .expense-name {
      font-size: 0.875rem;
      line-height: 1.35;
      color: var(--text-ui);
      word-break: break-word;
    }

    .expense-eur {
      font-size: 0.74rem;
      color: var(--muted-text-ui);
      margin-top: 1px;
    }

    .expense-meta {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .expense-base-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      color: #334155;
      font-size: 0.64rem;
      font-weight: 600;
      line-height: 1;
      padding: 2px 7px;
      letter-spacing: 0.01em;
      text-transform: uppercase;
    }

    .expense-isk {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-ui);
      white-space: nowrap;
    }

    .budget-calc {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border-ui);
    }

    #fx-card .budget-calc {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .budget-calc-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--muted-text-ui);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }

    .budget-calc-output {
      min-width: 112px;
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      background: var(--muted-ui);
      font-size: 0.84rem;
      font-weight: 600;
      color: var(--text-ui);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 7px 10px;
    }

    .useful-links-list {
      display: grid;
      gap: 8px;
    }

    .useful-link {
      display: block;
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      background: var(--muted-ui);
      padding: 9px 10px;
      text-decoration: none;
      color: inherit;
    }

    .useful-link-title {
      display: block;
      font-size: 0.86rem;
      font-weight: 700;
      color: var(--text-ui);
      line-height: 1.2;
    }

    .useful-link-url {
      display: block;
      font-size: 0.72rem;
      color: var(--muted-text-ui);
      margin-top: 2px;
      word-break: break-word;
    }

    .useful-link:hover {
      background: #ffffff;
      border-color: #a1a1aa;
    }

    .pack-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 0;
      border-bottom: 1px solid var(--border-ui);
      background: transparent;
    }

    .pack-item:last-child {
      border-bottom: none;
    }

    .pack-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--success-ui);
      flex-shrink: 0;
      display: block;
      cursor: pointer;
    }

    .pack-label {
      flex: 1;
      font-size: 0.875rem;
      font-weight: 400;
      line-height: 1.4;
      min-width: 0;
      word-break: break-word;
      cursor: pointer;
    }

    .pack-label.done {
      color: var(--muted-text-ui);
      text-decoration: line-through;
    }

    .pack-edit-input {
      flex: 1;
      border: 1px solid var(--border-ui);
      border-radius: 6px;
      padding: 3px 8px;
      font-size: 0.875rem;
      font-family: var(--font-ui);
      outline: none;
    }

    .item-actions {
      display: flex;
      gap: 2px;
      flex-shrink: 0;
      margin-left: auto;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .pack-item:hover .item-actions {
      opacity: 1;
    }

    @media (hover: none) {
      .item-actions {
        opacity: 1;
      }
    }

    .act-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      color: var(--muted-text-ui);
      display: flex;
      align-items: center;
      transition: color 0.15s, background 0.15s;
    }

    .act-btn:hover {
      background: var(--muted-ui);
      color: var(--text-ui);
    }

    .act-btn.del:hover {
      color: #dc2626;
    }

    .act-btn svg {
      width: 13px;
      height: 13px;
    }

    .day-card {
      border: 1px solid var(--border-ui);
      border-radius: var(--radius-ui);
      margin-bottom: 9px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }

    .day-card summary {
      padding: 12px 13px;
      border-left: 3px solid var(--day-color);
      background: color-mix(in srgb, var(--day-color) 18%, white);
      transition: filter 0.15s;
    }

    .day-card summary:hover {
      filter: brightness(0.97);
    }

    .day-number {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: var(--day-color);
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .day-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: color-mix(in srgb, var(--day-color) 75%, black);
    }

    .fullscreen-trigger {
      border: 1px solid var(--border-ui);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-ui);
      box-shadow: none;
      padding: 5px 9px;
      font-size: 0.72rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .fullscreen-trigger .open-icon {
      font-size: 0.8rem;
      line-height: 1;
    }

    .fullscreen-trigger:hover {
      background: var(--muted-ui);
      color: var(--text-ui);
    }

    .day-content {
      border-top: 1px solid var(--border-ui);
      padding: 13px 14px 14px;
      font-size: 0.875rem;
    }

    .meta-row {
      gap: 5px;
      margin-bottom: 11px;
    }

    .tag {
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      border-radius: 100px;
      padding: 2px 9px;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--muted-text-ui);
    }

    .day-drive-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .drive-plan {
      opacity: 0.72;
      font-size: 0.64rem;
      white-space: nowrap;
    }

    .map-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      color: var(--text-ui);
      border-radius: 8px;
      padding: 9px 14px;
      font-size: 0.82rem;
      font-weight: 500;
      text-decoration: none;
    }

    .map-link:hover {
      background: var(--border-ui);
      text-decoration: none;
    }

    .day-content h4,
    .fullscreen-card h4 {
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--muted-text-ui);
      margin: 11px 0 6px;
    }

    .fullscreen-modal {
      background: rgba(9, 9, 11, 0.55);
      backdrop-filter: blur(5px);
      align-items: flex-start;
      overflow-y: auto;
    }

    .fullscreen-modal.open {
      display: flex;
    }

    .fullscreen-panel {
      background: var(--card-ui);
      width: 100%;
      min-height: 100dvh;
      max-width: 680px;
      margin: 0 auto;
      animation: slideIn 0.22s cubic-bezier(0.4, 0, 0.2, 1);
      display: block;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(14px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fullscreen-head {
      color: var(--text-ui);
      background: var(--muted-ui);
      border-bottom: 1px solid var(--border-ui);
      border-left: 4px solid var(--day-color, transparent);
      padding: 18px 15px 15px;
      align-items: flex-start;
      position: sticky;
      top: 0;
      z-index: 1200;
    }

    .fullscreen-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-ui);
    }

    #fullscreen-subtitle {
      color: var(--muted-text-ui) !important;
      font-size: 0.75rem;
      margin-top: 3px;
    }

    #fullscreen-subtitle .drive-plan {
      font-size: 0.7rem;
      margin-left: 6px;
    }

    #close-fullscreen {
      border: 1px solid var(--border-ui);
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-ui);
      border-radius: 7px;
      padding: 5px 11px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    #close-fullscreen:hover {
      background: var(--muted-ui);
    }

    .fullscreen-body {
      padding: 15px 15px calc(15px + var(--tab-bar-safe-height) + env(safe-area-inset-bottom, 0px));
      background: var(--card-ui);
      position: relative;
      z-index: 1;
    }

    .fullscreen-card {
      border: 1px solid var(--border-ui);
      border-radius: var(--radius-ui);
      box-shadow: none;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }

    .map-embed {
      min-height: 260px;
      border: none;
      border-radius: 0;
      background: var(--muted-ui);
      margin: 0 0 8px;
      position: relative;
      z-index: 1;
    }

    .route-strip {
      gap: 5px;
      margin-bottom: 8px;
    }

    .route-stop {
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      border-radius: 100px;
      padding: 2px 9px;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--muted-text-ui);
    }

    .route-stop.campsite-stop {
      border-color: #bfdbfe;
      background: #eff6ff;
      color: #1e3a8a;
      font-weight: 600;
    }

    .route-dot {
      width: 7px;
      height: 7px;
      box-shadow: none;
    }

    .itinerary-list {
      gap: 10px;
      margin-top: 6px;
    }

    .location-card,
    .recommendation-item {
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      box-shadow: none;
      padding: 9px 10px;
      background: #fff;
    }

    .location-name,
    .recommendation-item h5 {
      font-size: 0.875rem;
      font-weight: 600;
    }

    .recommendation-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .recommendation-kind {
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.66rem;
      font-weight: 600;
      color: var(--muted-text-ui);
      white-space: nowrap;
    }

    .location-note,
    .recommendation-item p,
    .muted {
      font-size: 0.78rem;
      color: var(--muted-text-ui);
    }

    .recommendation-price {
      margin-top: 6px;
      font-size: 0.72rem;
      font-weight: 600;
      color: #0f766e;
    }

    .recommendation-price.free {
      color: #166534;
    }

    .recommendation-action {
      margin-top: 7px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      color: var(--text-ui);
      border-radius: 7px;
      padding: 4px 9px;
      font-size: 0.72rem;
      font-weight: 600;
      text-decoration: none;
    }

    .recommendation-action:hover {
      background: color-mix(in srgb, var(--muted-ui) 65%, #ffffff);
      border-color: #a1a1aa;
    }

    .location-card.campsite-card {
      border-color: #bfdbfe;
      background: linear-gradient(180deg, #eff6ff 0%, #ffffff 60%);
    }

    .location-name .stop-icon {
      margin-right: 6px;
    }

    .location-image {
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      transition: border-color 0.15s, background 0.15s, opacity 0.25s ease;
      position: relative;
      z-index: 1;
    }

    .location-media {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: var(--muted-ui);
    }

    .location-media.loading .location-image {
      opacity: 0;
    }

    .image-loader {
      position: absolute;
      inset: 0;
      border: 1px solid var(--border-ui);
      border-radius: 8px;
      background:
        linear-gradient(
          100deg,
          rgba(228, 228, 231, 0.65) 8%,
          rgba(244, 244, 245, 0.95) 18%,
          rgba(228, 228, 231, 0.65) 33%
        ),
        var(--muted-ui);
      background-size: 220% 100%;
      animation: imageLoaderShimmer 1.2s linear infinite;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      z-index: 0;
    }

    .location-media.loading .image-loader {
      opacity: 1;
    }

    @keyframes imageLoaderShimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -20% 0;
      }
    }

    .img-refresh-btn {
      position: absolute;
      right: 8px;
      bottom: 8px;
      border: 1px solid rgba(255, 255, 255, 0.85);
      background: rgba(9, 9, 11, 0.72);
      color: #ffffff;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.68rem;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 2;
    }

    .img-refresh-btn:hover {
      background: rgba(9, 9, 11, 0.85);
    }

    .img-refresh-btn:disabled {
      opacity: 0.65;
      cursor: wait;
    }

    .location-discovery-links {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0 8px;
    }

    .discovery-link {
      border: 1px solid var(--border-ui);
      background: var(--muted-ui);
      color: var(--muted-text-ui);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.68rem;
      font-weight: 600;
      text-decoration: none;
      line-height: 1.35;
    }

    .discovery-link:hover {
      border-color: #a1a1aa;
      background: #ffffff;
      color: var(--text-ui);
    }

    .location-title-link {
      color: inherit;
      text-decoration: none;
      text-decoration-color: transparent;
      text-underline-offset: 2px;
    }

    .location-title-link:hover {
      text-decoration: underline;
      text-decoration-color: currentColor;
    }

    .route-stop,
    .location-title-link {
      text-decoration: none;
      color: inherit;
    }

    .route-stop:hover {
      background: var(--border-ui);
    }

    .location-card:hover {
      border-color: #a1a1aa;
      background: var(--muted-ui);
    }

    .location-link-inline {
      color: inherit;
      text-decoration: underline;
      text-decoration-color: var(--muted-text-ui);
      text-underline-offset: 2px;
    }

    .location-link-inline:hover {
      color: var(--text-ui);
      text-decoration-color: var(--text-ui);
    }

    .itinerary-drive-time {
      margin: -2px 0 6px 32px;
      width: fit-content;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px dashed var(--border-ui);
      background: var(--muted-ui);
      color: var(--muted-text-ui);
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 0.72rem;
      font-weight: 500;
    }

    .itinerary-road-summary {
      margin: -2px 0 4px 32px;
      width: fit-content;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border-ui);
      background: #ffffff;
      color: var(--muted-text-ui);
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .itinerary-road-summary.road-link {
      text-decoration: none;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }

    .itinerary-road-summary.road-link:hover {
      border-color: #a1a1aa;
      color: var(--text-ui);
      background: var(--muted-ui);
    }

    .itinerary-road-summary.loading {
      opacity: 0.82;
      font-style: italic;
    }

    .itinerary-drive-time.loading {
      opacity: 0.82;
      font-style: italic;
    }

    @media (max-width: 640px) {
      .shell {
        width: 94vw;
      }

      #budget-max-form {
        grid-template-columns: 1fr;
      }

      #expense-form {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      }

      #expense-form .btn-primary {
        grid-column: 1 / -1;
        width: 100%;
      }

      .budget-calc .budget-form {
        grid-template-columns: 1fr;
      }

      .budget-calc-output {
        width: 100%;
      }

      .location-discovery-links {
        gap: 5px;
      }

      .discovery-link {
        font-size: 0.64rem;
      }

      .recommendation-action {
        width: 100%;
        justify-content: center;
      }

      .day-card summary {
        padding: 12px;
      }

      .day-title {
        font-size: 0.9rem;
      }

      .btn-ghost {
        font-size: 0.72rem;
        padding: 6px 8px;
      }

      .map-embed {
        min-height: 240px;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <video id="header-video" class="header-video" autoplay muted loop playsinline preload="metadata" aria-hidden="true">
      <source src="https://videos.pexels.com/video-files/31280471/13358080_1920_1080_25fps.mp4" type="video/mp4">
      <source src="https://upload.wikimedia.org/wikipedia/commons/f/ff/Aurora-Iceland_Northern_Lights_timelapse_2026-02-06.hd.webm" type="video/webm">
    </video>
    <div class="header-video-overlay" aria-hidden="true"></div>
    <div class="header-content">
      <h1><span class="header-flag" aria-hidden="true">üáÆüá∏</span><span class="header-title-text">Iceland Epic</span></h1>
      <p class="dates">March 4 ‚Äì 14, 2026</p>
      <p class="couple">Ebba &amp; Alexis ‚ù§Ô∏è</p>
    </div>
    <section id="departure-countdown-card" class="card countdown-card" aria-label="Countdown to departure">
      <div id="departure-countdown-days" class="countdown-days">0 days</div>
      <div id="departure-countdown-time" class="countdown-sub">00h 00m</div>
      <div class="countdown-caption">before the great north</div>
    </section>
  </header>

  <div class="shell">
    <section id="flight-card" class="card" aria-labelledby="flight-title">
      <h2 id="flight-title" class="card-title">‚úàÔ∏è Flights</h2>
      <div id="outbound-flight-block" class="flight-block outbound-flight-block">
        <div class="flight-badge">Outbound ¬∑ Mar 4</div>
        <div class="flight-route">Orly 14:25 ‚Üí Keflavik 17:15</div>
        <div class="flight-ref">EJU4895 ¬∑ Ref: K93RDQ3</div>
      </div>
      <div id="return-flight-block" class="flight-block return-flight-block">
        <div class="flight-badge">Return ¬∑ Mar 14</div>
        <div class="flight-route">Keflavik 17:15 ‚Üí Orly 21:35</div>
        <div class="flight-ref">EJU4898 ¬∑ Ref: KBHPM1R</div>
      </div>
    </section>

    <section id="packing-card" class="card" aria-labelledby="pack-title">
      <h2 id="pack-title" class="card-title">üéí Packing List</h2>
      <div class="prog-row">
        <span id="prog-label">0 packed</span>
        <span id="prog-pct">0%</span>
      </div>
      <div class="prog-bar" aria-hidden="true">
        <div class="prog-fill" id="pack-progress"></div>
      </div>

      <form id="add-item-form" class="add-row">
        <input id="new-item-input" class="text-input" type="text" placeholder="Add an item‚Ä¶" maxlength="100" aria-label="Add packing item">
        <button class="btn-primary" type="submit">Add</button>
      </form>

      <div id="packlist" aria-live="polite"></div>
    </section>

    <section id="fx-card" class="card" aria-labelledby="fx-title">
      <h2 id="fx-title" class="card-title">üí± ISK ‚Üí EUR Calculator</h2>
      <div class="budget-calc">
        <div class="budget-calc-label">ISK ‚Üí EUR Calculator</div>
        <div class="budget-form" style="margin-bottom:0;">
          <input id="budget-calc-isk-input" class="text-input budget-amount-input" type="number" min="0" step="1" placeholder="Amount in ISK" aria-label="Calculator amount in ISK">
          <output id="budget-calc-output" class="budget-calc-output">‚Ç¨0.00</output>
        </div>
      </div>
    </section>

    <section id="useful-links-card" class="card" aria-labelledby="useful-links-title">
      <h2 id="useful-links-title" class="card-title">üîó Useful Links</h2>
      <div class="useful-links-list">
        <a class="useful-link" href="https://gottvedur.is/" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Weather</span>
          <span class="useful-link-url">gottvedur.is</span>
        </a>
        <a class="useful-link" href="https://umferdin.is/en" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Road conditions</span>
          <span class="useful-link-url">umferdin.is/en</span>
        </a>
        <a class="useful-link" href="https://safetravel.is/" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Safety alerts</span>
          <span class="useful-link-url">safetravel.is</span>
        </a>
        <a class="useful-link" href="https://en.vedur.is/" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Official met office</span>
          <span class="useful-link-url">en.vedur.is</span>
        </a>
        <a class="useful-link" href="https://auroraforecast.is/" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Aurora forecast</span>
          <span class="useful-link-url">auroraforecast.is</span>
        </a>
        <a class="useful-link" href="https://gasvaktin.is/" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Fuel prices</span>
          <span class="useful-link-url">gasvaktin.is</span>
        </a>
        <a class="useful-link" href="https://www.isavia.is/en/keflavik-airport" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Keflavik airport info</span>
          <span class="useful-link-url">isavia.is/en/keflavik-airport</span>
        </a>
        <a class="useful-link" href="https://straeto.is/en" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Public transport</span>
          <span class="useful-link-url">straeto.is/en</span>
        </a>
        <a class="useful-link" href="https://www.112.is/en" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Emergency info (112)</span>
          <span class="useful-link-url">112.is/en</span>
        </a>
        <a class="useful-link" href="https://www.ruv.is/english" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">News in English</span>
          <span class="useful-link-url">ruv.is/english</span>
        </a>
        <a class="useful-link" href="https://www.yr.no/en" target="_blank" rel="noopener noreferrer">
          <span class="useful-link-title">Weather backup</span>
          <span class="useful-link-url">yr.no/en</span>
        </a>
      </div>
    </section>

    <section id="budget-card" class="card" aria-labelledby="budget-title">
      <h2 id="budget-title" class="card-title">üí∏ Budget</h2>
      <div class="budget-summary">
        <span id="budget-main" class="budget-main">0 ISK / 0 ISK</span>
        <span id="budget-percent" class="budget-percent">0%</span>
        <span id="budget-eur" class="muted">‚Ç¨0.00 / ‚Ç¨0.00</span>
      </div>
      <div class="prog-bar" aria-hidden="true">
        <div class="prog-fill" id="budget-progress"></div>
      </div>
      <div id="budget-rate" class="budget-rate loading">Loading ISK‚ÜíEUR daily rate‚Ä¶</div>
      <div id="budget-base-note" class="budget-rate"></div>

      <form id="budget-max-form" class="budget-form">
        <input id="budget-max-input" class="text-input budget-amount-input" type="number" min="0" step="100" placeholder="Max budget (ISK)" aria-label="Max budget in ISK">
        <button class="btn-primary" type="submit">Set max</button>
      </form>

      <form id="expense-form" class="budget-form">
        <input id="expense-name-input" class="text-input" type="text" maxlength="100" placeholder="Expense name" aria-label="Expense name">
        <input id="expense-amount-input" class="text-input budget-amount-input" type="number" min="0" step="1" placeholder="Amount ISK" aria-label="Expense amount in ISK">
        <button class="btn-primary" type="submit">Add</button>
      </form>

      <div id="budget-list" aria-live="polite"></div>
    </section>

    <h2 id="days-section-title" class="section-title">Itinerary Days</h2>
    <section id="days-container" aria-label="Iceland trip days"></section>
  </div>

  <div class="tab-shell" role="navigation" aria-label="Main tabs">
    <div class="tab-bar" role="tablist" aria-label="Views">
      <button class="tab-btn active" type="button" role="tab" aria-selected="true" data-tab="home">
        <span class="tab-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false">
            <path d="M3 11.5 12 4l9 7.5"/>
            <path d="M5.5 10.5V20h13V10.5"/>
            <path d="M10 20v-5h4v5"/>
          </svg>
        </span>
        <span class="tab-label">Home</span>
      </button>
      <button class="tab-btn" type="button" role="tab" aria-selected="false" data-tab="itinerary">
        <span class="tab-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false">
            <path d="M12 3v18"/>
            <path d="M12 6h7l-2 3 2 3h-7"/>
            <path d="M12 10H5l2 3-2 3h7"/>
          </svg>
        </span>
        <span class="tab-label">Itinerary</span>
      </button>
      <button class="tab-btn" type="button" role="tab" aria-selected="false" data-tab="tools">
        <span class="tab-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false">
            <path d="M14.5 5.5 18.5 9.5"/>
            <path d="m13 7 4 4"/>
            <path d="M6 21 17 10"/>
            <path d="M4.5 19.5a1.5 1.5 0 0 1 0-2.1l1.2-1.2 2.1 2.1-1.2 1.2a1.5 1.5 0 0 1-2.1 0z"/>
          </svg>
        </span>
        <span class="tab-label">Tools</span>
      </button>
    </div>
  </div>

  <div id="fullscreen-modal" class="fullscreen-modal" role="dialog" aria-modal="true" aria-labelledby="fullscreen-title">
    <div class="fullscreen-panel">
      <div id="fullscreen-head" class="fullscreen-head">
        <div>
          <h3 id="fullscreen-title" class="fullscreen-title"></h3>
          <p id="fullscreen-subtitle" class="muted" style="color: rgba(255,255,255,0.92);"></p>
        </div>
        <button id="close-fullscreen" class="btn btn-ghost" type="button">‚úï</button>
      </div>
      <div class="fullscreen-body">
        <div class="fullscreen-card">
          <div id="fullscreen-map" class="map-embed" role="img" aria-label="Day itinerary map"></div>
          <div id="fullscreen-route" class="route-strip"></div>
          <a id="fullscreen-map-link" class="map-link" target="_blank" rel="noopener noreferrer">üìç Open route map in Google Maps</a>
          <p class="muted">Interactive map with the day's itinerary route overlay.</p>
        </div>

        <div class="fullscreen-card">
          <h4>Itinerary</h4>
          <div id="fullscreen-itinerary" class="itinerary-list"></div>
        </div>

        <div class="fullscreen-card">
          <h4>Recommendations</h4>
          <div id="fullscreen-reco" class="recommendation-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const dayColors = [
      "var(--day-1)",
      "var(--day-2)",
      "var(--day-3)",
      "var(--day-4)",
      "var(--day-5)",
      "var(--day-6)",
      "var(--day-7)",
      "var(--day-8)",
      "var(--day-9)",
      "var(--day-10)",
      "var(--day-11)"
    ];

    const IMAGE_CACHE_STORAGE_KEY = "icelandImageUrlCacheV1";
    const DRIVE_CACHE_STORAGE_KEY = "icelandDriveLegCacheV1";
    const IMAGE_CACHE_MAX_ITEMS = 240;
    const DRIVE_CACHE_MAX_ITEMS = 180;
    const WIKIMEDIA_SEARCH_LIMIT = 16;
    const HEADER_VIDEO_CACHE_NAME = "icelandMediaCacheV1";
    const HEADER_VIDEO_PRIMARY_URL = "https://videos.pexels.com/video-files/31280471/13358080_1920_1080_25fps.mp4";
    const GOOGLE_PLACES_API_KEY = "AIzaSyBxwWsUASKhG8zALOa_V73RTlAj7lgDfNU";
    const GOOGLE_PLACES_STORAGE_KEY = "icelandGooglePlacesApiKey";
    let headerVideoBlobUrl = "";

    function readLocalStorageObject(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) {
          return {};
        }
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch {
        return {};
      }
    }

    function writeLocalStorageObject(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch {
        // localStorage might be unavailable/quota-limited; skip persistence.
      }
    }

    function playHeaderVideo(videoEl) {
      if (!videoEl || typeof videoEl.play !== "function") {
        return;
      }
      const playPromise = videoEl.play();
      if (playPromise && typeof playPromise.catch === "function") {
        playPromise.catch(() => {});
      }
    }

    async function applyCachedHeaderVideoResponse(videoEl, response) {
      if (!videoEl || !response) {
        return;
      }

      const blob = await response.blob();
      if (!blob || !blob.size) {
        return;
      }

      if (headerVideoBlobUrl) {
        URL.revokeObjectURL(headerVideoBlobUrl);
      }
      headerVideoBlobUrl = URL.createObjectURL(blob);
      videoEl.src = headerVideoBlobUrl;
      videoEl.load();
      playHeaderVideo(videoEl);
    }

    async function refreshHeaderVideoCache(cache, request) {
      try {
        const networkResponse = await fetch(request, { cache: "no-store" });
        if (!networkResponse || !networkResponse.ok) {
          return;
        }
        const contentType = String(networkResponse.headers.get("content-type") || "");
        if (!contentType.includes("video/")) {
          return;
        }
        await cache.put(request, networkResponse.clone());
      } catch {
        // network/cache failures are non-blocking for header playback.
      }
    }

    async function cacheHeaderVideo() {
      const videoEl = document.getElementById("header-video");
      if (!videoEl || !("caches" in window)) {
        return;
      }

      try {
        const cache = await caches.open(HEADER_VIDEO_CACHE_NAME);
        const request = new Request(HEADER_VIDEO_PRIMARY_URL, {
          mode: "cors",
          credentials: "omit"
        });
        const cached = await cache.match(request, { ignoreVary: true });

        if (cached) {
          await applyCachedHeaderVideoResponse(videoEl, cached.clone());
          refreshHeaderVideoCache(cache, request);
          return;
        }

        refreshHeaderVideoCache(cache, request);
      } catch {
        // keep native source loading if cache API is unavailable or fails.
      }
    }

    let imageUrlCache = readLocalStorageObject(IMAGE_CACHE_STORAGE_KEY);
    let driveTimesStorageCache = readLocalStorageObject(DRIVE_CACHE_STORAGE_KEY);
    const wikimediaImageSearchCache = {};
    const googlePlacesImageSearchCache = {};

    function compactObjectCache(cacheObject, maxItems) {
      const entries = Object.entries(cacheObject || {});
      if (entries.length <= maxItems) {
        return cacheObject;
      }

      entries.sort((a, b) => {
        const aTs = Number((a[1] && a[1].updatedAt) || 0);
        const bTs = Number((b[1] && b[1].updatedAt) || 0);
        return bTs - aTs;
      });

      const trimmed = {};
      entries.slice(0, maxItems).forEach(([key, value]) => {
        trimmed[key] = value;
      });
      return trimmed;
    }

    function imageTagsFor(keyword) {
      return ("iceland," + String(keyword).toLowerCase())
        .replace(/[^a-z0-9]+/g, ",")
        .replace(/,+/g, ",")
        .replace(/^,|,$/g, "");
    }

    function instagramRelatedImageFor(keyword, seed) {
      const tags = imageTagsFor(keyword);
      return (
        "https://source.unsplash.com/featured/1200x800/?" +
        encodeURIComponent("instagram," + tags) +
        "&sig=" +
        encodeURIComponent(String(seed))
      );
    }

    function loremImageFor(keyword, seed) {
      const tags = imageTagsFor(keyword);
      return "https://loremflickr.com/1200/800/" + tags + "?lock=" + seed;
    }

    function imageFor(keyword, seed) {
      return instagramRelatedImageFor(keyword, seed);
    }

    function hashString(value) {
      const text = String(value || "");
      let hash = 0;
      for (let index = 0; index < text.length; index += 1) {
        hash = (hash << 5) - hash + text.charCodeAt(index);
        hash |= 0;
      }
      return hash;
    }

    function pickBySeed(items, seed) {
      if (!Array.isArray(items) || !items.length) {
        return "";
      }
      const index = Math.abs(hashString(String(seed || "0"))) % items.length;
      return items[index] || "";
    }

    function getGooglePlacesApiKey() {
      const fromWindow =
        typeof window !== "undefined" && typeof window.GOOGLE_PLACES_API_KEY === "string"
          ? window.GOOGLE_PLACES_API_KEY.trim()
          : "";
      if (fromWindow) {
        return fromWindow;
      }

      try {
        const fromStorage = String(localStorage.getItem(GOOGLE_PLACES_STORAGE_KEY) || "").trim();
        if (fromStorage) {
          return fromStorage;
        }
      } catch {
        // ignore storage access errors
      }

      if (typeof GOOGLE_PLACES_API_KEY === "string" && GOOGLE_PLACES_API_KEY.trim()) {
        return GOOGLE_PLACES_API_KEY.trim();
      }

      return "";
    }

    function fetchGooglePlacesFallbackImage(keyword, seed) {
      const apiKey = getGooglePlacesApiKey();
      if (!apiKey) {
        return Promise.resolve("");
      }

      const rawKeyword = String(keyword || "Iceland").trim();
      const searchKeyword = rawKeyword.toLowerCase().includes("iceland")
        ? rawKeyword
        : rawKeyword + ", Iceland";
      const cacheKey = searchKeyword.toLowerCase();

      if (Array.isArray(googlePlacesImageSearchCache[cacheKey]) && googlePlacesImageSearchCache[cacheKey].length) {
        return Promise.resolve(pickBySeed(googlePlacesImageSearchCache[cacheKey], cacheKey + "|" + seed));
      }

      return fetch("https://places.googleapis.com/v1/places:searchText", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Goog-Api-Key": apiKey,
          "X-Goog-FieldMask": "places.photos"
        },
        body: JSON.stringify({
          textQuery: searchKeyword,
          pageSize: 5
        })
      })
        .then((response) => (response.ok ? response.json() : null))
        .then((payload) => {
          const places = payload && Array.isArray(payload.places) ? payload.places : [];
          const photoNames = places
            .flatMap((place) => (Array.isArray(place.photos) ? place.photos : []))
            .map((photo) => (photo && typeof photo.name === "string" ? photo.name : ""))
            .filter(Boolean);

          if (!photoNames.length) {
            return "";
          }

          const uniquePhotoNames = Array.from(new Set(photoNames));
          const targetPhotoName = pickBySeed(uniquePhotoNames, cacheKey + "|" + seed);
          if (!targetPhotoName) {
            return "";
          }

          const encodedPhotoPath = targetPhotoName
            .split("/")
            .map((segment) => encodeURIComponent(segment))
            .join("/");
          const mediaUrl =
            "https://places.googleapis.com/v1/" +
            encodedPhotoPath +
            "/media?maxHeightPx=900&skipHttpRedirect=true&key=" +
            encodeURIComponent(apiKey);

          return fetch(mediaUrl, { cache: "no-store" })
            .then((photoResponse) => (photoResponse.ok ? photoResponse.json() : null))
            .then((photoPayload) => {
              const resolvedUrl =
                photoPayload && typeof photoPayload.photoUri === "string"
                  ? photoPayload.photoUri
                  : "";
              if (!resolvedUrl) {
                return "";
              }

              googlePlacesImageSearchCache[cacheKey] = [resolvedUrl];
              return resolvedUrl;
            });
        })
        .catch(() => "");
    }

    function fetchWikimediaFallbackImage(keyword, seed) {
      const rawKeyword = String(keyword || "Iceland").trim();
      const searchKeyword = rawKeyword.toLowerCase().includes("iceland")
        ? rawKeyword
        : rawKeyword + " Iceland";
      const cacheKey = searchKeyword.toLowerCase();

      if (Array.isArray(wikimediaImageSearchCache[cacheKey]) && wikimediaImageSearchCache[cacheKey].length) {
        return Promise.resolve(pickBySeed(wikimediaImageSearchCache[cacheKey], cacheKey + "|" + seed));
      }

      const endpoint =
        "https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*" +
        "&generator=search&gsrnamespace=6&gsrlimit=" + WIKIMEDIA_SEARCH_LIMIT +
        "&gsrsearch=" + encodeURIComponent(searchKeyword) +
        "&prop=imageinfo&iiprop=url|mime&iiurlwidth=1280";

      return fetch(endpoint, { cache: "no-store" })
        .then((response) => (response.ok ? response.json() : null))
        .then((payload) => {
          const pages = payload && payload.query && payload.query.pages
            ? Object.values(payload.query.pages)
            : [];

          const imageUrls = pages
            .map((page) => {
              const info = page && Array.isArray(page.imageinfo) ? page.imageinfo[0] : null;
              if (!info) {
                return "";
              }
              const mime = String(info.mime || "");
              if (mime && !mime.startsWith("image/")) {
                return "";
              }
              return info.thumburl || info.url || "";
            })
            .filter(Boolean);

          if (!imageUrls.length) {
            return "";
          }

          wikimediaImageSearchCache[cacheKey] = imageUrls;
          return pickBySeed(imageUrls, cacheKey + "|" + seed);
        })
        .catch(() => "");
    }

    function buildLocationRefreshImageUrl(locationName, dayNumber, stopIndex, nonce) {
      const safeDay = Number.isFinite(dayNumber) ? dayNumber : 0;
      const safeStop = Number.isFinite(stopIndex) ? stopIndex : 0;
      const baseSeed = safeDay * 1000 + safeStop + 1;
      const uniqueSeed = baseSeed + (Number.isFinite(nonce) ? nonce : 0);
      const keyword = String(locationName || "iceland location");
      return imageFor(keyword, uniqueSeed) + "&refresh=" + encodeURIComponent(String(nonce || Date.now()));
    }

    function buildLocationRefreshLoremUrl(locationName, dayNumber, stopIndex, nonce) {
      const safeDay = Number.isFinite(dayNumber) ? dayNumber : 0;
      const safeStop = Number.isFinite(stopIndex) ? stopIndex : 0;
      const baseSeed = safeDay * 10000 + safeStop + 1;
      const uniqueSeed = baseSeed + (Number.isFinite(nonce) ? nonce : Date.now());
      return loremImageFor(String(locationName || "iceland location"), uniqueSeed);
    }

    function getLocationImageCacheKey(dayNumber, stopIndex, locationName) {
      const normalizedName = String(locationName || "stop")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
      return "d" + dayNumber + "-s" + (stopIndex + 1) + "-" + normalizedName;
    }

    function getCachedImageUrl(imageKey) {
      const cached = imageUrlCache[imageKey];
      return cached && typeof cached.url === "string" ? cached.url : "";
    }

    function saveCachedImageUrl(imageKey, imageUrl) {
      if (!imageKey || typeof imageUrl !== "string" || !imageUrl.trim()) {
        return;
      }

      imageUrlCache[imageKey] = {
        url: imageUrl,
        updatedAt: Date.now()
      };
      imageUrlCache = compactObjectCache(imageUrlCache, IMAGE_CACHE_MAX_ITEMS);
      writeLocalStorageObject(IMAGE_CACHE_STORAGE_KEY, imageUrlCache);
    }

    function imageLoaded(event) {
      const img = event.target;
      const imageKey = img.dataset.imageKey || "";
      const currentUrl = img.currentSrc || img.src;
      if (imageKey && currentUrl) {
        saveCachedImageUrl(imageKey, currentUrl);
        img.dataset.cachedSrc = currentUrl;
      }
      img.dataset.skipCached = "0";
      img.dataset.fallbackStage = "0";
      const media = img.closest(".location-media");
      if (media) {
        media.classList.remove("loading");
      }
    }

    function rotateProviders(list, offset) {
      const items = Array.isArray(list) ? list.slice() : [];
      if (items.length <= 1) {
        return items;
      }
      const normalizedOffset = ((offset % items.length) + items.length) % items.length;
      if (!normalizedOffset) {
        return items;
      }
      return items.slice(normalizedOffset).concat(items.slice(0, normalizedOffset));
    }

    function getFallbackProviderChain(img) {
      const skipCached = img && img.dataset && img.dataset.skipCached === "1";
      const spinOffset = Number.parseInt((img && img.dataset && img.dataset.providerSpin) || "0", 10) || 0;
      const rotatingProviders = rotateProviders(["google", "wikimedia", "lorem"], spinOffset);
      const chain = [];

      if (!skipCached) {
        chain.push("cached");
      }
      chain.push(...rotatingProviders, "picsum");
      return chain;
    }

    function continueImageFallback(img) {
      if (!img) {
        return;
      }

      const stage = Number.parseInt(img.dataset.fallbackStage || "0", 10);
      const providers = getFallbackProviderChain(img);
      if (stage >= providers.length) {
        const media = img.closest(".location-media");
        if (media) {
          media.classList.remove("loading");
        }
        return;
      }
      const provider = providers[stage];
      img.dataset.fallbackStage = String(stage + 1);

      if (provider === "cached") {
        const cached = img.dataset.cachedSrc || "";
        if (cached && cached !== img.src) {
          img.src = cached;
          return;
        }
        continueImageFallback(img);
        return;
      }

      if (provider === "google") {
        const keyword = img.dataset.locationName || "Iceland";
        const seed = img.dataset.fallbackSeed || "iceland-fallback";
        fetchGooglePlacesFallbackImage(keyword, seed)
          .then((googlePlacesSrc) => {
            if (googlePlacesSrc && googlePlacesSrc !== img.src) {
              img.src = googlePlacesSrc;
              return;
            }
            continueImageFallback(img);
          })
          .catch(() => {
            continueImageFallback(img);
          });
        return;
      }

      if (provider === "wikimedia") {
        const keyword = img.dataset.locationName || "Iceland";
        const seed = img.dataset.fallbackSeed || "iceland-fallback";
        fetchWikimediaFallbackImage(keyword, seed)
          .then((wikimediaSrc) => {
            if (wikimediaSrc && wikimediaSrc !== img.src) {
              img.src = wikimediaSrc;
              return;
            }
            continueImageFallback(img);
          })
          .catch(() => {
            continueImageFallback(img);
          });
        return;
      }

      if (provider === "lorem") {
        const loremSrc = img.dataset.loremSrc || "";
        if (loremSrc && loremSrc !== img.src) {
          img.src = loremSrc;
          return;
        }
        continueImageFallback(img);
        return;
      }

      const seed = img.dataset.fallbackSeed || "iceland-fallback";
      img.src = "https://picsum.photos/seed/" + seed + "/1200/800";
    }

    function imageFallback(event) {
      continueImageFallback(event.target);
    }

    function refetchLocationImage(button) {
      if (!button) {
        return;
      }

      const media = button.closest(".location-media");
      if (!media) {
        return;
      }

      const img = media.querySelector(".location-image");
      if (!img) {
        return;
      }

      const locationName = img.dataset.locationName || "iceland location";
      const dayNumber = Number.parseInt(img.dataset.dayNumber || "0", 10);
      const stopIndex = Number.parseInt(img.dataset.stopIndex || "0", 10);
      const nonce = Date.now();

      const unlock = () => {
        button.disabled = false;
        button.removeAttribute("aria-busy");
      };

      button.disabled = true;
      button.setAttribute("aria-busy", "true");
      img.addEventListener("load", unlock, { once: true });
      img.addEventListener("error", unlock, { once: true });
      media.classList.add("loading");

      img.dataset.cachedSrc = "";
      img.dataset.skipCached = "1";
      img.dataset.providerSpin = String(
        (Number.parseInt(img.dataset.providerSpin || "0", 10) || 0) + 1
      );
      img.dataset.loremSrc = buildLocationRefreshLoremUrl(locationName, dayNumber, stopIndex, nonce);
      img.dataset.fallbackSeed = dayNumber + "-" + (stopIndex + 1) + "-" + nonce;
      img.dataset.fallbackStage = "0";
      img.src = buildLocationRefreshImageUrl(locationName, dayNumber, stopIndex, nonce);
    }

    function buildMapEmbed(bounds) {
      const encoded = bounds.join("%2C");
      return "https://www.openstreetmap.org/export/embed.html?bbox=" + encoded + "&layer=mapnik";
    }

    function extractRouteCoordinatesFromLink(mapLink) {
      const decoded = decodeURIComponent(mapLink || "");
      const regex = /!1d(-?\d+(?:\.\d+)?)!2d(-?\d+(?:\.\d+)?)/g;
      const points = [];
      let match;
      while ((match = regex.exec(decoded)) !== null) {
        const lon = Number.parseFloat(match[1]);
        const lat = Number.parseFloat(match[2]);
        if (Number.isFinite(lat) && Number.isFinite(lon)) {
          points.push([lat, lon]);
        }
      }
      return points;
    }

    function getDayRoutePoints(day) {
      const locationRoute = day.locations
        .filter((location) => Array.isArray(location.coords) && location.coords.length === 2)
        .map((location) => location.coords);
      if (locationRoute.length === day.locations.length && locationRoute.length > 1) {
        return locationRoute;
      }

      const routeFromLink = extractRouteCoordinatesFromLink(day.mapLink || "");
      if (routeFromLink.length > 1) {
        return routeFromLink;
      }

      return locationRoute;
    }

    function locationMapsUrl(location, fallbackPoint) {
      const point =
        (Array.isArray(location.coords) && location.coords.length === 2 && location.coords) ||
        (Array.isArray(fallbackPoint) && fallbackPoint.length === 2 && fallbackPoint) ||
        null;

      if (point) {
        return "https://www.google.com/maps/search/?api=1&query=" + point[0] + "," + point[1];
      }

      const query = encodeURIComponent((location.name || "Iceland") + ", Iceland");
      return "https://www.google.com/maps/search/?api=1&query=" + query;
    }

    function mapsSearchUrl(query) {
      return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(query);
    }

    function bookingSearchUrl(query) {
      return "https://www.getyourguide.com/s/?q=" + encodeURIComponent(query);
    }

    function mapsDirectionsUrl(fromLocation, toLocation, fromPoint, toPoint) {
      const fromHasCoords = Array.isArray(fromPoint) && fromPoint.length === 2;
      const toHasCoords = Array.isArray(toPoint) && toPoint.length === 2;

      if (fromHasCoords && toHasCoords) {
        return (
          "https://www.google.com/maps/dir/?api=1" +
          "&origin=" + encodeURIComponent(fromPoint[0] + "," + fromPoint[1]) +
          "&destination=" + encodeURIComponent(toPoint[0] + "," + toPoint[1]) +
          "&travelmode=driving"
        );
      }

      const origin = String((fromLocation && fromLocation.name) || "Iceland").trim();
      const destination = String((toLocation && toLocation.name) || "Iceland").trim();
      return (
        "https://www.google.com/maps/dir/?api=1" +
        "&origin=" + encodeURIComponent(origin) +
        "&destination=" + encodeURIComponent(destination) +
        "&travelmode=driving"
      );
    }

    function getLocationDiscoveryLinks(location) {
      const placeName = String((location && location.name) || "Iceland").trim();
      const base = placeName + ", Iceland";
      return [
        { label: "üçΩ Restaurants", url: mapsSearchUrl("restaurants near " + base) },
        { label: "‚òï Cafes", url: mapsSearchUrl("cafes near " + base) },
        { label: "üèõ Cultural", url: mapsSearchUrl("cultural sites near " + base) },
        { label: "üìç Attractions", url: mapsSearchUrl("tourist attractions near " + base) }
      ];
    }

    function normalizePlaceText(value) {
      return String(value || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/\([^)]*\)/g, " ")
        .replace(/[^a-z0-9]+/g, " ")
        .trim();
    }

    function placeKeywords(value) {
      const stopWords = new Set([
        "camp",
        "campsite",
        "home",
        "exchange",
        "plan",
        "the",
        "and",
        "or",
        "for",
        "with",
        "stay"
      ]);
      return normalizePlaceText(value)
        .split(" ")
        .filter((token) => token.length >= 3 && !stopWords.has(token));
    }

    function hasSharedPlaceKeyword(a, b) {
      const left = placeKeywords(a);
      const right = new Set(placeKeywords(b));
      return left.some((token) => right.has(token));
    }

    function shouldAppendCampStop(day, locations) {
      const campName = String(day.camp || "").trim();
      if (!campName || /departure/i.test(campName)) {
        return false;
      }
      if (!locations.length) {
        return true;
      }
      const lastLocation = locations[locations.length - 1];
      if (lastLocation && (lastLocation.isCampsite || lastLocation.isCamp)) {
        return false;
      }
      return !hasSharedPlaceKeyword(campName, lastLocation ? lastLocation.name : "");
    }

    function getDisplayLocations(day, routePoints = getDayRoutePoints(day)) {
      const locations = day.locations.map((location) => ({
        ...location,
        isCampsite: Boolean(location.isCampsite || location.isCamp)
      }));
      if (!shouldAppendCampStop(day, locations)) {
        return locations;
      }

      const campName = String(day.camp || "Campsite").trim();
      const routeFromLink = extractRouteCoordinatesFromLink(day.mapLink || "");
      const knownCampCoordsByName = [
        { match: "gesthus selfoss", coords: [63.9330556, -20.9888091] },
        { match: "hamrar akureyri", coords: [65.6485410, -18.1024258] },
        { match: "home exchange reykjavik", coords: [64.1459810, -21.9422367] }
      ];
      const normalizedCampName = normalizePlaceText(campName);
      const mappedCampCoordsEntry = knownCampCoordsByName.find((entry) =>
        normalizedCampName.includes(entry.match)
      );
      const routeEndPoint =
        (routeFromLink.length > locations.length &&
          Array.isArray(routeFromLink[routeFromLink.length - 1]) &&
          routeFromLink[routeFromLink.length - 1]) ||
        routePoints.length > locations.length && Array.isArray(routePoints[routePoints.length - 1])
          ? routePoints[routePoints.length - 1]
          : mappedCampCoordsEntry
            ? mappedCampCoordsEntry.coords
            : null;

      locations.push({
        name: campName,
        note: "Overnight stop. Check in, organize gear, and recharge for tomorrow.",
        image: imageFor("iceland campsite " + campName, day.day * 100 + 99),
        coords: routeEndPoint,
        isCampsite: true,
        isCamp: true
      });

      return locations;
    }

    const LEG_DURATION_OVERRIDES = {
      4: [
        {
          from: "Jokulsarlon Lagoon",
          to: "Diamond Beach",
          seconds: 5 * 60
        }
      ]
    };

    function getLegDurationOverride(day, fromLocation, toLocation) {
      const dayOverrides = LEG_DURATION_OVERRIDES[day.day];
      if (!Array.isArray(dayOverrides)) {
        return null;
      }

      const fromName = normalizePlaceText(fromLocation && fromLocation.name);
      const toName = normalizePlaceText(toLocation && toLocation.name);

      for (const override of dayOverrides) {
        if (
          fromName === normalizePlaceText(override.from) &&
          toName === normalizePlaceText(override.to) &&
          Number.isFinite(override.seconds)
        ) {
          return override.seconds;
        }
      }
      return null;
    }

    function getLegDurationSeconds(day, fromLocation, toLocation, legSummary) {
      const overrideSeconds = getLegDurationOverride(day, fromLocation, toLocation);
      if (Number.isFinite(overrideSeconds)) {
        return overrideSeconds;
      }
      if (legSummary && Number.isFinite(legSummary.duration)) {
        return legSummary.duration;
      }
      return null;
    }

    function getDayDriveAggregate(day, driveLegSummaries = []) {
      const routePoints = getDayRoutePoints(day);
      const locations = getDisplayLocations(day, routePoints);
      const legCount = Math.max(0, locations.length - 1);
      let totalSeconds = 0;
      let knownLegs = 0;

      for (let index = 0; index < legCount; index += 1) {
        const durationSeconds = getLegDurationSeconds(
          day,
          locations[index],
          locations[index + 1],
          driveLegSummaries[index]
        );
        if (Number.isFinite(durationSeconds) && durationSeconds > 0) {
          totalSeconds += durationSeconds;
          knownLegs += 1;
        }
      }

      return {
        legCount,
        knownLegs,
        missingLegs: Math.max(0, legCount - knownLegs),
        totalSeconds: knownLegs ? totalSeconds : null
      };
    }

    function getDayDriveDisplay(day, driveLegSummaries = []) {
      const aggregate = getDayDriveAggregate(day, driveLegSummaries);
      if (!Number.isFinite(aggregate.totalSeconds)) {
        return {
          main: day.drive,
          planned: null
        };
      }

      const derived = formatDriveDuration(aggregate.totalSeconds) + " total";
      if (aggregate.missingLegs > 0) {
        return {
          main: derived + " (partial)",
          planned: day.drive
        };
      }

      return {
        main: derived,
        planned: day.drive
      };
    }

    function renderDayDriveTag(day, driveLegSummaries = []) {
      const tag = document.querySelector('[data-day-drive="' + day.day + '"]');
      if (!tag) {
        return;
      }

      const display = getDayDriveDisplay(day, driveLegSummaries);
      const planHtml = display.planned
        ? "<span class=\"drive-plan\">plan: " + escapeHtml(display.planned) + "</span>"
        : "";
      tag.innerHTML =
        "üöó " +
        "<span class=\"drive-main\">" + escapeHtml(display.main) + "</span>" +
        planHtml;
    }

    function renderFullscreenSubtitle(day, driveLegSummaries = []) {
      const display = getDayDriveDisplay(day, driveLegSummaries);
      const campPricing = getDayCampPricing(day);
      const campPriceSuffix = campPricing
        ? " ¬∑ " + getCampPriceDisplayText(campPricing)
        : "";
      const planHtml = display.planned
        ? "<span class=\"drive-plan\">plan: " + escapeHtml(display.planned) + "</span>"
        : "";
      modalSubtitleEl.innerHTML =
        "<span class=\"drive-main\">" + escapeHtml(display.main) + "</span>" +
        planHtml +
        " ¬∑ ‚õ∫ " +
        escapeHtml(day.camp) +
        campPriceSuffix;
    }

    function formatDriveDuration(seconds) {
      if (!Number.isFinite(seconds) || seconds <= 0) {
        return "Unknown";
      }
      const totalMinutes = Math.round(seconds / 60);
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;

      if (!hours) {
        return minutes + "m";
      }
      if (!minutes) {
        return hours + "h";
      }
      return hours + "h " + minutes + "m";
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function getCardinalDirection(fromPoint, toPoint) {
      if (
        !Array.isArray(fromPoint) ||
        !Array.isArray(toPoint) ||
        fromPoint.length !== 2 ||
        toPoint.length !== 2
      ) {
        return "Unknown";
      }

      const lat1 = (fromPoint[0] * Math.PI) / 180;
      const lat2 = (toPoint[0] * Math.PI) / 180;
      const deltaLon = ((toPoint[1] - fromPoint[1]) * Math.PI) / 180;
      const y = Math.sin(deltaLon) * Math.cos(lat2);
      const x =
        Math.cos(lat1) * Math.sin(lat2) -
        Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
      const bearing = ((Math.atan2(y, x) * 180) / Math.PI + 360) % 360;
      const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      return directions[Math.round(bearing / 45) % 8];
    }

    function collectRoadNumbersFromText(text, bucket) {
      if (typeof text !== "string" || !text.trim()) {
        return;
      }

      const upper = text.toUpperCase();

      upper.split(/[;,/|]/).forEach((segment) => {
        const token = segment.trim();
        if (/^(?:F)?\d{1,3}[A-Z]?$/.test(token)) {
          bucket.add(token);
        }
      });

      const routePattern = /\b(?:ROUTE|ROAD|RTE)\s*(F?\d{1,3}[A-Z]?)\b/g;
      let match;
      while ((match = routePattern.exec(upper)) !== null) {
        bucket.add(match[1]);
      }

      const fRoadPattern = /\b(F\d{1,3})\b/g;
      while ((match = fRoadPattern.exec(upper)) !== null) {
        bucket.add(match[1]);
      }
    }

    function extractRoadNumbersFromLeg(leg) {
      const roads = new Set();
      if (!leg || !Array.isArray(leg.steps)) {
        return [];
      }

      leg.steps.forEach((step) => {
        collectRoadNumbersFromText(step.ref, roads);
        collectRoadNumbersFromText(step.name, roads);
        collectRoadNumbersFromText(step.destinations, roads);
      });

      return Array.from(roads).slice(0, 4);
    }

    function summarizeDrivingLeg(leg, fromPoint, toPoint) {
      return {
        duration: Number.isFinite(leg && leg.duration) ? leg.duration : null,
        roads: extractRoadNumbersFromLeg(leg),
        direction: getCardinalDirection(fromPoint, toPoint)
      };
    }

    const driveTimesCache = new Map();

    function getDriveRouteCacheKey(day, route) {
      return (
        String(day.day) +
        "|" +
        route.map((point) => point[0].toFixed(5) + "," + point[1].toFixed(5)).join(";")
      );
    }

    function sanitizeDriveLegSummaries(rawValue) {
      if (!Array.isArray(rawValue)) {
        return [];
      }
      return rawValue.map((entry) => ({
        duration:
          entry && Number.isFinite(entry.duration)
            ? Number(entry.duration)
            : null,
        roads:
          entry && Array.isArray(entry.roads)
            ? entry.roads
                .filter((road) => typeof road === "string" && road.trim().length > 0)
                .slice(0, 6)
            : [],
        direction:
          entry && typeof entry.direction === "string" && entry.direction.trim()
            ? entry.direction
            : "Unknown"
      }));
    }

    function getPersistedDriveLegSummaries(cacheKey) {
      const entry = driveTimesStorageCache[cacheKey];
      if (!entry) {
        return [];
      }

      if (Array.isArray(entry)) {
        return sanitizeDriveLegSummaries(entry);
      }

      return sanitizeDriveLegSummaries(entry.summaries);
    }

    function savePersistedDriveLegSummaries(cacheKey, summaries) {
      driveTimesStorageCache[cacheKey] = {
        updatedAt: Date.now(),
        summaries: sanitizeDriveLegSummaries(summaries)
      };
      driveTimesStorageCache = compactObjectCache(driveTimesStorageCache, DRIVE_CACHE_MAX_ITEMS);
      writeLocalStorageObject(DRIVE_CACHE_STORAGE_KEY, driveTimesStorageCache);
    }

    function getCachedDrivingLegDurations(day) {
      const route = getDayRoutePoints(day);
      if (route.length < 2) {
        return [];
      }

      const cacheKey = getDriveRouteCacheKey(day, route);

      if (driveTimesCache.has(cacheKey)) {
        return driveTimesCache.get(cacheKey);
      }

      const persisted = getPersistedDriveLegSummaries(cacheKey);
      if (persisted.length) {
        driveTimesCache.set(cacheKey, persisted);
      }
      return persisted;
    }

    async function fetchDrivingLegDurations(day) {
      const route = getDayRoutePoints(day);
      if (route.length < 2) {
        return [];
      }

      const cacheKey = getDriveRouteCacheKey(day, route);
      const fallbackSummaries = getCachedDrivingLegDurations(day);

      const coordinateParam = route.map((point) => point[1] + "," + point[0]).join(";");
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        coordinateParam +
        "?overview=false&steps=true&annotations=false";

      try {
        const response = await fetch(url, {
          headers: {
            Accept: "application/json"
          }
        });

        if (!response.ok) {
          throw new Error("OSRM request failed with status " + response.status);
        }

        const data = await response.json();
        const legs =
          data && data.routes && data.routes[0] && Array.isArray(data.routes[0].legs)
            ? data.routes[0].legs
            : [];

        const summaries = legs.map((leg, index) =>
          summarizeDrivingLeg(leg, route[index], route[index + 1])
        );
        driveTimesCache.set(cacheKey, summaries);
        savePersistedDriveLegSummaries(cacheKey, summaries);
        return summaries;
      } catch (error) {
        console.warn("Drive time lookup failed", error);
        return fallbackSummaries;
      }
    }

    const days = [
      {
        day: 1,
        title: "The Discovery",
        drive: "~1.5h Drive",
        camp: "Reykjavik / Thingvellir",
        mapLink: "https://www.google.com/maps/dir/Keflav%C3%ADk+International+Airport,+Keflav%C3%ADk,+Iceland/Reykjav%C3%ADk,+Iceland/Thingvellir+National+Park,+Selfoss,+Iceland/data=!4m20!4m19!1m5!1m1!19sChIJn3mr4vz9KUkRzSjDFQqN-Cc!2m2!1d-22.623943999999998!2d63.9948577!1m5!1m1!19sChIJw-3c7rl01kgRcWDSMKIskew!2m2!1d-21.940755199999998!2d64.1469868!1m5!1m1!19sChIJe2kT-x-B1kgR8mKSB4tsdWs!2m2!1d-21.0764492!2d64.2821725!3e0",
        mapEmbed: buildMapEmbed([-22.9,63.95,-20.85,64.35]),
        locations: [
          { name: "Keflavik Airport", note: "Pick up the van, SIM card, and road snacks.", image: imageFor("Keflavik Airport", 101), coords: [63.9965506, -22.6251460] },
          { name: "Reykjavik Grocery Stop", note: "Stock up in Bonus or Kronan before leaving the city.", image: imageFor("Reykjavik street", 102), coords: [64.1459810, -21.9422367] },
          { name: "Thingvellir National Park", note: "Golden hour walk between tectonic plates.", image: imageFor("Thingvellir National Park", 103), coords: [64.2786081, -21.0819412] }
        ],
        recommendations: [
          { title: "Braud & Co", text: "Great first-stop bakery for warm cinnamon buns; grab extra for tomorrow's early drive." },
          { title: "Baejarins Beztu Pylsur", text: "Fast and iconic hot dog stand, perfect for a no-fuss first Iceland dinner." }
        ]
      },
      {
        day: 2,
        title: "Golden Circle Day",
        drive: "~3h Drive",
        camp: "Gesth√∫s Selfoss",
        mapLink: "https://www.google.com/maps/dir/Thingvellir+National+Park,+Selfoss,+Iceland/Geysir/Gullfoss+Falls/Keri%C3%B0+Crater,+Klausturholar,+Iceland/Hrunalaug+Hot+Spring,+S%C3%B3lheimar,+Fl%C3%BA%C3%B0ir,+Iceland/Gesth%C3%BAs+Selfoss,+Engjavegur+56,+Selfoss,+Iceland/data=!4m38!4m37!1m5!1m1!19sChIJe2kT-x-B1kgR8mKSB4tsdWs!2m2!1d-21.0764492!2d64.2821725!1m5!1m1!19sChIJP09CA5-j1kgRPyjiYhocdbQ!2m2!1d-20.3023605!2d64.310371899999993!1m5!1m1!19sChIJybZFr3Sl1kgRARZBC9tHYyw!2m2!1d-20.1199478!2d64.3270716!1m5!1m1!19sChIJV_L2VbeL1kgRB9kuweBEWlE!2m2!1d-20.8851466!2d64.04127849999999!1m5!1m1!19sChIJ24-g5ju-1kgRay4MayAeeUA!2m2!1d-20.2551249!2d64.1327657!1m5!1m1!19sChIJJyXX28lf1kgRJDG96H4pABQ!2m2!1d-20.988809099999997!2d63.933055599999996!3e0",
        mapEmbed: buildMapEmbed([-21.35,63.9,-20.05,64.38]),
        locations: [
          { name: "Thingvellir National Park", note: "Short morning walk before heading deeper inland.", image: imageFor("Thingvellir Iceland", 201), coords: [64.2786081, -21.0819412] },
          { name: "Strokkur Geyser", note: "Erupts every few minutes, ideal for repeated photo attempts.", image: imageFor("Strokkur geyser", 202), coords: [64.3126964, -20.3007733] },
          { name: "Gullfoss Waterfall", note: "Powerful canyon waterfall with multiple viewpoints.", image: imageFor("Gullfoss waterfall", 203), coords: [64.3266103, -20.1216821] },
          { name: "Kerid Crater", note: "Volcanic crater lake with vivid red and blue contrast.", image: imageFor("Kerid crater", 204), coords: [64.0417879, -20.8864810] },
          { name: "Hrunalaug Hot Spring", note: "Small rustic soak to close the day.", image: imageFor("Iceland hot spring", 205), coords: [64.1328671, -20.2549498] },
          { name: "Gesth√∫s Selfoss", note: "Campsite base for the night with amenities and easy morning departure.", image: imageFor("Selfoss Iceland", 206), coords: [63.9330556, -20.9888091], isCamp: true },
        ],
        recommendations: [
          { title: "Fridheimar", text: "Book ahead for a greenhouse tomato lunch; warm and cozy even in harsh weather." },
          { title: "Efstidalur II", text: "Farm-made ice cream stop with mountain views and good coffee." }
        ]
      },
      {
        day: 3,
        title: "Dramatic Waterfalls",
        drive: "~2.5h Drive",
        camp: "Vik or Thakgil",
        mapLink: "https://www.google.com/maps/dir/Selfoss,+Iceland/Seljalandsfoss/Sk%C3%B3gafoss/Dyrh%C3%B3laey,+Iceland/Reynisfjara+Beach/Vik,+Iceland/data=!4m38!4m37!1m5!1m1!19sChIJywmZh8tf1kgRET-0iMl3mVw!2m2!1d-20.9996925!2d63.931832199999995!1m5!1m1!19sChIJFSTv6K0e10gRjRcJUiDmAa4!2m2!1d-19.9885688!2d63.615623199999995!1m5!1m1!19sChIJFYylOXY710gRSHn-zR_HYA8!2m2!1d-19.511370499999998!2d63.5320523!1m5!1m1!19sChIJmdOPSLJJ10gRcudiVCXKJSc!2m2!1d-19.1185521!2d63.4046799!1m5!1m1!19sChIJfSZn1YRJ10gR1Wuz9KNUeeA!2m2!1d-19.0716193!2d63.4057404!1m5!1m1!19sChIJ0bA2SUJK10gRjXdtABtTg74!2m2!1d-18.9974396!2d63.4176505!3e0",
        mapEmbed: buildMapEmbed([-20.2,63.35,-18.85,63.72]),
        locations: [
          { name: "Seljalandsfoss", note: "Walk-behind waterfall path, usually wet and windy.", image: imageFor("Seljalandsfoss", 301), coords: [63.6154571, -19.9881686] },
          { name: "Seljavallalaug", note: "Optional detour to a hidden historic pool.", image: imageFor("Seljavallalaug", 302), coords: [63.5661398, -19.6075649] },
          { name: "Skogafoss", note: "Wide waterfall with mist rainbows on sunny moments.", image: imageFor("Skogafoss", 303), coords: [63.5321038, -19.5112920] },
          { name: "Dyrholaey Viewpoint", note: "Cliff panoramas and ocean arches.", image: imageFor("Dyrholaey", 304), coords: [63.4018535, -19.1296788] },
          { name: "Reynisfjara Beach", note: "Black sand and basalt columns; watch strong waves.", image: imageFor("Reynisfjara", 305), coords: [63.4044262, -19.0586361] },
          { name: "Vik Campsite", note: "Settle in and recover from the long driving day.", image: imageFor("Vik", 306), coords: [63.4193981, -18.9957523], isCamp: true }
        ],
        recommendations: [
          { title: "Mia's Country Van", text: "Reliable fish and chips stop when you want a quick warm meal." },
          { title: "Smidjan Brugghus", text: "Good end-of-day burger and craft beer option in Vik." }
        ]
      },
      {
        day: 4,
        title: "The Diamond Day",
        drive: "~4h Drive",
        camp: "Vestrahorn Campsite",
        mapLink: "https://www.google.com/maps/dir/Vik,+Iceland/Fja%C3%B0r%C3%A1rglj%C3%BAfur,+Iceland/Svartifoss,+Iceland/Sv%C3%ADnafellsj%C3%B6kull/J%C3%B6kuls%C3%A1rl%C3%B3n+Lagoon,+Iceland/Diamond+Beach,+Iceland/Vestrahorn,+Iceland/",
        mapEmbed: buildMapEmbed([-18.35,63.7,-14.75,64.35]),
        locations: [
          { name: "Fjadrargljufur Canyon", note: "Short scenic canyon trail and viewpoints.", image: imageFor("Fjadrargljufur canyon", 401), coords: [63.771279, -18.171816] },
          { name: "Svartifoss", note: "Basalt-column waterfall hike in Skaftafell.", image: imageFor("Svartifoss", 402), coords: [64.027528, -16.975308] },
          { name: "Svinafellsjokull", note: "Close-up glacier tongue views.", image: imageFor("Svinafellsjokull glacier", 403), coords: [64.018592, -16.821478] },
          { name: "Jokulsarlon Lagoon", note: "Icebergs drifting from glacier to sea.", image: imageFor("Jokulsarlon", 404), coords: [64.048600, -16.179900] },
          { name: "Diamond Beach", note: "Ice fragments scattered across black sand.", image: imageFor("Diamond beach iceland", 405), coords: [64.078444, -16.230556] },
          { name: "Vestrahorn", note: "Epic final light at the dramatic mountain ridge.", image: imageFor("Vestrahorn", 406), coords: [64.273333, -15.008611] },
          { name: "Vestrahorn Campsite", note: "Settle in and recover from the long driving day.", image: imageFor("Vestrahorn campsite", 407), coords: [64.2550701, -14.9940489], isCamp: true }
        ],
        recommendations: [
          { title: "Systrakaffi", text: "Practical lunch stop with hearty plates before long stretches." },
          { title: "Pakkhus", text: "Great seafood dinner in Hofn, especially local langoustine." }
        ]
      },
      {
        day: 5,
        title: "Day of the Canyons",
        drive: "~4-8h Drive",
        camp: "Camp Egilsstadir",
        mapLink: "https://www.google.com/maps/dir/Vestrahorn/Lagarflj%C3%B3t+Lake/Stu%C3%B0lagil+Canyon/Egilssta%C3%B0ir,+Iceland/",
        mapEmbed: buildMapEmbed([-16.75,64.9,-14.05,65.92]),
        locations: [
          { name: "Vestrahorn", note: "Early light shots before heading north-east.", image: imageFor("Vestrahorn sunrise", 501), coords: [64.273333, -15.008611] },
          { name: "Lagarfljot", note: "Quiet lake break around Egilsstadir region.", image: imageFor("Lagarfljot", 502), coords: [65.1696214, -14.6333108] },
          { name: "Studlagil Canyon", note: "Basalt columns and turquoise river views.", image: imageFor("Studlagil canyon", 503), coords: [65.1623267, -15.3081247] },
          { name: "Egilsstadir Camp", note: "Settle in and recover from the long driving day.", image: imageFor("Egilsstadir", 505), coords: [65.2583124, -14.4068894], isCamp: true }
        ],
        recommendations: [
          { title: "Salt Cafe & Bistro", text: "Solid comfort-food stop for refueling in East Iceland." },
          { title: "Vok Baths", text: "Floating geothermal pools with a calmer vibe than larger lagoons." }
        ]
      },
      {
        day: 6,
        title: "Day of the Gods",
        drive: "~3h Drive",
        camp: "Hamrar (Akureyri)",
        mapLink: "https://www.google.com/maps/dir/Egilssta%C3%B0ir,+Iceland/N%C3%A1maskard/Go%C3%B0afoss+Waterfall/Akureyri,+Iceland/data=!4m26!4m25!1m5!1m1!19sChIJ056oDYAEzEgRVH98LGtBv5U!2m2!1d-14.399439399999999!2d65.2609232!1m5!1m1!19sChIJBxz9UKGfzUgR1lrqxPH-eEg!2m2!1d-16.826666799999998!2d65.6472222!1m5!1m1!19sChIJnzYfSGp-zUgROx0NTqrNu34!2m2!1d-17.5501918!2d65.6827782!1m5!1m1!19sChIJp7-wHAeP0kgR0f1xjHkytr0!2m2!1d-18.0906859!2d65.6825509!3e0",
        mapEmbed: buildMapEmbed([-18.35,65.2,-14.1,65.95]),
        locations: [
          { name: "Egilsstadir", note: "Coffee and supplies before crossing highlands roads.", image: imageFor("Egilsstadir city", 601), coords: [65.2620412, -14.4035258] },
          { name: "Namaskard", note: "Steaming geothermal vents and sulfur-colored hills.", image: imageFor("Namaskard", 602), coords: [65.6473428, -16.8250680] },
          { name: "Godafoss", note: "Classic horseshoe waterfall with easy access trails.", image: imageFor("Godafoss", 603), coords: [65.6828162, -17.5506240] },
          { name: "Akureyri", note: "Explore town center and harbor streets.", image: imageFor("Akureyri", 604), coords: [65.6839036, -18.1121756] },
          { name: "Forest Lagoon", note: "Evening soak overlooking Eyjafjordur.", image: imageFor("Forest lagoon iceland", 605), coords: [65.6699183, -18.0417986] }
        ],
        recommendations: [
          { title: "Vogafjos Farm Resort", text: "Known for local dairy and hearty plates in a farm setting." },
          { title: "Rub23", text: "High-quality sushi and seafood for a more refined dinner stop." }
        ]
      },
      {
        day: 7,
        title: "Less Dramatic Waterfalls",
        drive: "~3h Drive",
        camp: "Budardalur Campsite",
        mapLink: "https://www.google.com/maps/dir/Akureyri,+Iceland/Fosslaug+geothermic+pool,+FJV8%2BMHM,+Unnamed+Road,+Varmahl%C3%AD%C3%B0,+Islandia/B%C3%BA%C3%B0ardalur,+Iceland/data=!4m20!4m19!1m5!1m1!19sChIJp7-wHAeP0kgR0f1xjHkytr0!2m2!1d-18.0906859!2d65.6825509!1m5!1m1!19sChIJrQl9EY0F00gRvGmSEP5icpA!2m2!1d-19.3835889!2d65.494216299999991!1m5!1m1!19sChIJJeb3swv51EgRPVpIzd0Gqpw!2m2!1d-21.7672907!2d65.1099356!3e0",
        mapEmbed: buildMapEmbed([-22.05,64.9,-18.0,65.8]),
        locations: [
          { name: "Akureyri Departure", note: "Quick city breakfast before westward drive.", image: imageFor("Akureyri morning", 701), coords: [65.6839036, -18.1121756] },
          { name: "Road 83 Coastal Segment", note: "Scenic fjord roads and photo pull-offs.", image: imageFor("Iceland fjord road", 702), coords: [65.9710942, -18.5304388] },
          { name: "Fosslaug", note: "Natural hot pool with river views.", image: imageFor("Fosslaug", 703), coords: [65.4964888, -19.3802608] },
          { name: "Reykyafoss", note: "Short detour to a quieter waterfall stop.", image: imageFor("Iceland waterfall", 704), coords: [65.4945591, -19.3831862] },
          { name: "Budardalur Campsite", note: "Calm overnight base before Snaefellsnes.", image: imageFor("Budardalur", 705), coords: [65.1099356, -21.7672907], isCamp: true }
        ],
        recommendations: [
          { title: "Saudarkrokur Bakery", text: "Ideal quick stop for pastries, coffee, and road snacks." },
          { title: "Erpsstadir Creamery", text: "Small farm creamery for skyr and house-made ice cream." }
        ]
      },
      {
        day: 8,
        title: "Coastal Poetry",
        drive: "~4h Drive",
        camp: "Snorrastadir Camp",
        mapLink: "https://www.google.com/maps/dir/B%C3%BA%C3%B0ardalur,+Iceland/Sv%C3%B6rtuloft+Lighthouse,+Sn%C3%A6fellsnes,+Iceland/Arnarstapi,+Iceland/Snorrasta%C3%B0ir+Campsite+%26+Accommodation,+Snorrasta%C3%B0ir+Fer%C3%B0a%C3%BEj%C3%B3nusta,+Borgarnes,+%C3%8Dsland/data=!4m26!4m25!1m5!1m1!19sChIJJeb3swv51EgRPVpIzd0Gqpw!2m2!1d-21.7672907!2d65.1099356!1m5!1m1!19sChIJJ-1B7uCPKkkRMMU_jc6Z2_U!2m2!1d-24.0390958!2d64.86380059999999!1m5!1m1!19sChIJlyAzMgiBKkkRUfLoebLqwz8!2m2!1d-23.6224317!2d64.7695169!1m5!1m1!19sChIJ2Tml4MKk1UgRiJ-b0l1sQ0I!2m2!1d-22.3012436!2d64.7736001!3e0",
        mapEmbed: buildMapEmbed([-24.35,64.6,-21.75,65.2]),
        locations: [
          { name: "Budardalur Start", note: "Morning setup before entering the peninsula.", image: imageFor("Budardalur road", 801), coords: [65.1099356, -21.7672907] },
          { name: "Svortuloft Lighthouse", note: "Remote cliffs and dramatic sea color.", image: imageFor("Svortuloft lighthouse", 802), coords: [64.8637148, -24.0390239] },
          { name: "Arnarstapi Cliffs", note: "Coastal walk with arches and seabirds.", image: imageFor("Arnarstapi", 803), coords: [64.7667270, -23.6280850] },
          { name: "Snorrastadir Camp", note: "Quiet base with easy next-day access.", image: imageFor("Snaefellsnes campsite", 804), coords: [64.7736001, -22.3012436], isCamp: true }
        ],
        recommendations: [
          { title: "Fjoruhusid Hellnum", text: "Simple, cozy cafe known for waffles and ocean-facing views." }
        ]
      },
      {
        day: 9,
        title: "Icelandic Culture",
        drive: "~2.5h Drive",
        camp: "Home Exchange (Reykjavik)",
        mapLink: "https://www.google.com/maps/dir/B%C3%BA%C3%B0ardalur,+Iceland/Reykjav%C3%ADk,+Iceland/Harpa,+Austurbakki+2,+101+Reykjav%C3%ADk,+Iceland/Perlan,+Varmahl%C3%AD%C3%B0+1,+105+Reykjav%C3%ADk,+Iceland",
        mapEmbed: buildMapEmbed([-22.05,64.03,-21.55,64.2]),
        locations: [
          { name: "Van Return", note: "Drop-off logistics before city mode starts. Return time: 11:00 AM.", image: imageFor("Reykjavik van rental", 901), coords: [64.1466, -21.9426] },
          { name: "Sun Voyager", note: "Iconic sculpture on the waterfront promenade.", image: imageFor("Sun Voyager Reykjavik", 902), coords: [64.1478, -21.9226] },
          { name: "Harpa Concert Hall", note: "Geometric glass facade and harbor views.", image: imageFor("Harpa Reykjavik", 903), coords: [64.1500, -21.9327] },
          { name: "Perlan", note: "Museum and hilltop panorama over Reykjavik.", image: imageFor("Perlan Reykjavik", 904), coords: [64.1293, -21.9219] }
        ],
        recommendations: [
          { title: "Saegreifinn", text: "Famous lobster soup spot near the old harbor, casual and quick." },
          { title: "Icelandic Street Food", text: "Budget-friendly soups and Icelandic classics in central Reykjavik." }
        ]
      },
      {
        day: 10,
        title: "The Day of Care",
        drive: "Relaxed city day",
        camp: "Home Exchange (Reykjavik)",
        mapLink: "https://www.google.com/maps/dir/Reykjav%C3%ADk,+Iceland/Sky+Lagoon,+Vesturv%C3%B6r+44-48,+K%C3%B3pavogur,+Iceland/Blue+Lagoon,+Nor%C3%B0urlj%C3%B3savegur+9,+240+Grindav%C3%ADk,+Iceland/Reykjav%C3%ADk,+Iceland",
        mapEmbed: buildMapEmbed([-22.05,63.8,-21.0,64.2]),
        locations: [
          { name: "Sky Lagoon", note: "Ocean-facing spa circuit and warm pools.", image: imageFor("Sky Lagoon Iceland", 1001), coords: [64.1197, -21.9112] },
          { name: "Blue Lagoon Option", note: "Alternative geothermal experience with milky-blue water.", image: imageFor("Blue Lagoon Iceland", 1002), coords: [63.8804, -22.4495] },
          { name: "Reykjavik Evening", note: "Slow city walk and recovery evening.", image: imageFor("Reykjavik evening", 1003), coords: [64.1466, -21.9426] }
        ],
        recommendations: [
          { title: "Lava Restaurant", text: "Premium option at Blue Lagoon for a special slow meal." },
          { title: "Kaffi Loki", text: "Great place to try rye bread ice cream and local comfort dishes." }
        ]
      },
      {
        day: 11,
        title: "Farewell Iceland",
        drive: "~1h Drive",
        camp: "Departure",
        mapLink: "https://www.google.com/maps/dir/Reykjav%C3%ADk,+Iceland/Keflav%C3%ADk+International+Airport,+Keflav%C3%ADk,+Iceland",
        mapEmbed: buildMapEmbed([-22.85,63.95,-21.55,64.2]),
        locations: [
          { name: "Last Reykjavik Breakfast", note: "Final bakery or coffee stop in the city.", image: imageFor("Reykjavik breakfast", 1101), coords: [64.1466, -21.9426] },
          { name: "Drive to Keflavik", note: "Leave time for fuel, drop-off, and tax-free desk.", image: imageFor("Keflavik road", 1102), coords: [64.0700, -22.1000] },
          { name: "Departure", note: "Airport check-in and final Iceland views from the gate.", image: imageFor("Keflavik airport", 1103), coords: [63.9850, -22.6056] }
        ],
        recommendations: [
          { title: "Airport Snack Run", text: "Pick up a final sandwich and treats before boarding." },
          { title: "Tax-Free Check", text: "Handle receipts before security to avoid missing refunds." }
        ]
      }
    ];

    const ENHANCED_RECOMMENDATIONS_BY_DAY = {
      1: [
        {
          title: "Thingvellir Rift Walk",
          kind: "Natural spot",
          text: "Walk the Almannagja fissure and Oxararfoss path at your own pace.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Silfra Snorkeling Tour",
          kind: "Tour",
          text: "Cold-water snorkeling between tectonic plates with certified guides.",
          priceISK: 17990,
          priceLabel: "From"
        },
        {
          title: "FlyOver Iceland",
          kind: "Activity",
          text: "Immersive flying theater over Icelandic landscapes in Reykjavik.",
          priceISK: 5690,
          priceLabel: "From"
        }
      ],
      2: [
        {
          title: "Gullfoss Upper Viewpoint",
          kind: "Natural spot",
          text: "Short walk to dramatic canyon-edge viewpoints above the falls.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Secret Lagoon",
          kind: "Activity",
          text: "Historic geothermal pool near Fludir for a relaxed soak.",
          priceISK: 4200,
          priceLabel: "Adult ticket"
        },
        {
          title: "Langjokull Snowmobile Tour",
          kind: "Tour",
          text: "Guided glacier snowmobile ride departing from the Geysir area.",
          priceISK: 33500,
          priceLabel: "From"
        }
      ],
      3: [
        {
          title: "Reynisfjara Black Sand Beach",
          kind: "Natural spot",
          text: "Basalt columns and ocean views; keep distance from sneaker waves.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Lava Show Vik",
          kind: "Activity",
          text: "Live molten lava demonstration with strong geology storytelling.",
          priceISK: 6590,
          priceLabel: "Adult ticket"
        },
        {
          title: "Katla Ice Cave Fast Track",
          kind: "Tour",
          text: "Super-jeep transfer and glacier cave walk departing from Vik.",
          priceISK: 22900,
          priceLabel: "From"
        }
      ],
      4: [
        {
          title: "Diamond Beach Sunrise",
          kind: "Natural spot",
          text: "Early light over black sand and ice fragments from Jokulsarlon.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Skaftafell Glacier Hike",
          kind: "Tour",
          text: "Entry-level guided glacier hike with safety gear included.",
          priceISK: 9900,
          priceLabel: "From"
        },
        {
          title: "Jokulsarlon Zodiac Boat",
          kind: "Tour",
          text: "Fast lagoon boat ride weaving between iceberg formations.",
          priceISK: 16900,
          priceLabel: "Adult ticket"
        }
      ],
      5: [
        {
          title: "Studlagil Canyon East Bank",
          kind: "Natural spot",
          text: "Basalt canyon viewpoints and river colors from the east side trail.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Vok Baths",
          kind: "Activity",
          text: "Floating geothermal pools on Lake Urridavatn near Egilsstadir.",
          priceISK: 7690,
          priceLabel: "From"
        },
        {
          title: "Hengifoss Hike",
          kind: "Natural spot",
          text: "Layered-cliff waterfall hike with broad Eastfjords views.",
          priceISK: 0,
          priceLabel: "Free access"
        }
      ],
      6: [
        {
          title: "Godafoss Waterfall Trail",
          kind: "Natural spot",
          text: "Easy riverside trail on both banks of the waterfall.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Forest Lagoon",
          kind: "Activity",
          text: "Thermal pools in a pine setting above Eyjafjordur.",
          priceISK: 6900,
          priceLabel: "From"
        },
        {
          title: "Akureyri Whale Watching",
          kind: "Tour",
          text: "Classic Eyjafjordur sailing with frequent humpback sightings.",
          priceISK: 14500,
          priceLabel: "From"
        }
      ],
      7: [
        {
          title: "Fosslaug Hot Pot",
          kind: "Natural spot",
          text: "Natural riverside hot pool with mountain views.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Kolugljufur Canyon Stop",
          kind: "Natural spot",
          text: "Short detour to a deep canyon and clustered waterfalls.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Into the Glacier",
          kind: "Tour",
          text: "Man-made ice tunnel experience inside Langjokull glacier.",
          priceISK: 23500,
          priceLabel: "From"
        }
      ],
      8: [
        {
          title: "Arnarstapi Coastal Walk",
          kind: "Natural spot",
          text: "Sea arches, bird cliffs, and lava coast viewpoints.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Vatnshellir Cave Tour",
          kind: "Tour",
          text: "Guided descent into an 8,000-year-old lava tube.",
          priceISK: 5900,
          priceLabel: "Adult ticket"
        },
        {
          title: "Olafsvik Whale Watching",
          kind: "Tour",
          text: "Peninsula whale tour focused on orca and minke sightings.",
          priceISK: 12500,
          priceLabel: "From"
        }
      ],
      9: [
        {
          title: "Sun Voyager Waterfront Walk",
          kind: "Natural spot",
          text: "Easy harbor walk combining sculpture stop and mountain backdrop.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Perlan Wonders of Iceland",
          kind: "Activity",
          text: "Ice cave exhibit, aurora film, and panoramic viewing deck.",
          priceISK: 5990,
          priceLabel: "From"
        },
        {
          title: "Reykjavik Whale Watching",
          kind: "Tour",
          text: "Old-harbor departure for bay cruises around Faxafloi.",
          priceISK: 14500,
          priceLabel: "From"
        }
      ],
      10: [
        {
          title: "Sky Lagoon",
          kind: "Activity",
          text: "Ocean-edge geothermal spa circuit with ritual access tiers.",
          priceISK: 12990,
          priceLabel: "From"
        },
        {
          title: "Blue Lagoon Comfort",
          kind: "Activity",
          text: "Geothermal lagoon with silica mask and drink included.",
          priceISK: 11990,
          priceLabel: "From"
        },
        {
          title: "Reykjadalur Hot River Hike",
          kind: "Natural spot",
          text: "Moderate hike to naturally warm river bathing valley.",
          priceISK: 0,
          priceLabel: "Free access"
        }
      ],
      11: [
        {
          title: "Bridge Between Continents",
          kind: "Natural spot",
          text: "Quick Reykjanes stop between North American and Eurasian plates.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Reykjanesviti Lighthouse Cliffs",
          kind: "Natural spot",
          text: "Final volcanic-coast viewpoints before heading to the airport.",
          priceISK: 0,
          priceLabel: "Free access"
        },
        {
          title: "Blue Lagoon (Departure Option)",
          kind: "Activity",
          text: "Optional final soak if your airport timing allows.",
          priceISK: 11990,
          priceLabel: "From"
        }
      ]
    };

    const DISCOVERY_RECOMMENDATIONS_BY_DAY = {
      1: [
        { title: "Icelandic Street Food", kind: "Restaurant", text: "Cozy downtown stop for traditional soups and hearty bowls." },
        { title: "Reykjavik Roasters", kind: "Cafe", text: "Specialty coffee with relaxed local vibe near central Reykjavik." },
        { title: "Hallgrimskirkja", kind: "Cultural spot", text: "Iconic church and city landmark with a panoramic tower view." },
        { title: "Harpa Concert Hall", kind: "Tourist attraction", text: "Waterfront glass architecture and one of Reykjavik's signature sights." }
      ],
      2: [
        { title: "Fridheimar", kind: "Restaurant", text: "Greenhouse tomato-focused lunch stop in the Golden Circle region." },
        { title: "Kaffi Krus", kind: "Cafe", text: "Selfoss cafe for pastries and quick road coffee." },
        { title: "Skalholt Cathedral", kind: "Cultural spot", text: "Historic bishopric site with deep Icelandic heritage." },
        { title: "Geysir Geothermal Area Visitor Zone", kind: "Tourist attraction", text: "Main geyser boardwalk and central sightseeing point." }
      ],
      3: [
        { title: "Smidjan Brugghus", kind: "Restaurant", text: "Popular Vik burger and craft beer dinner option." },
        { title: "Skool Beans Micro Roaster", kind: "Cafe", text: "Converted-school-bus coffee stop with strong local character." },
        { title: "Vikurkirkja Church", kind: "Cultural spot", text: "Hilltop church overlooking Vik and black sand coast." },
        { title: "Reynisfjara Basalt Columns", kind: "Tourist attraction", text: "Distinctive basalt formations by the Reynisfjara beach area." }
      ],
      4: [
        { title: "Pakkhus Restaurant Hofn", kind: "Restaurant", text: "Seafood and langoustine-focused dining in Hofn." },
        { title: "Hafnarbudin Cafe Hofn", kind: "Cafe", text: "Harbor-side coffee and bakery pause before evening drive." },
        { title: "Hornafjordur Cultural Center", kind: "Cultural spot", text: "Small local exhibitions and insight into southeast Iceland life." },
        { title: "Jokulsarlon Main Viewpoint", kind: "Tourist attraction", text: "Prime observation area for iceberg movement and lagoon views." }
      ],
      5: [
        { title: "Salt Cafe & Bistro", kind: "Restaurant", text: "Comfort-food stop in East Iceland after long driving legs." },
        { title: "Cafe Nielsen Egilsstadir", kind: "Cafe", text: "Classic town cafe and bakery break in Egilsstadir." },
        { title: "East Iceland Heritage Museum", kind: "Cultural spot", text: "Regional history and local storytelling exhibits." },
        { title: "Studlagil East Side Viewpoint", kind: "Tourist attraction", text: "Most scenic approach to Studlagil's basalt canyon walls." }
      ],
      6: [
        { title: "Strikid Akureyri", kind: "Restaurant", text: "Rooftop dining with fjord and town views." },
        { title: "Blaa Kannan Cafe", kind: "Cafe", text: "Colorful cafe in Akureyri center for coffee and cakes." },
        { title: "Akureyri Church", kind: "Cultural spot", text: "Historic hilltop church designed by Gudjon Samuelsson." },
        { title: "Akureyri Botanical Garden", kind: "Tourist attraction", text: "Compact botanical garden with Arctic-flora focus." }
      ],
      7: [
        { title: "Saudarkrokur Bakery", kind: "Restaurant", text: "Casual bakery lunch and road snack stop." },
        { title: "Erpsstadir Creamery", kind: "Cafe", text: "Farm creamery for coffee, skyr, and homemade ice cream." },
        { title: "Eiriksstadir Viking Longhouse", kind: "Cultural spot", text: "Reconstructed Viking-era site tied to saga history." },
        { title: "Gudrunarlaug Hot Spring", kind: "Tourist attraction", text: "Historic hot spring stop in the west Iceland region." }
      ],
      8: [
        { title: "Arnarbaer Restaurant", kind: "Restaurant", text: "Well-known Snaefellsnes dining stop for fish and lamb dishes." },
        { title: "Fjoruhusid Hellnar", kind: "Cafe", text: "Coastal cafe famous for waffles and ocean views." },
        { title: "Bjarnarhofn Shark Museum", kind: "Cultural spot", text: "Traditional food and maritime heritage museum." },
        { title: "Kirkjufell Viewpoint", kind: "Tourist attraction", text: "Classic photo stop at Iceland's iconic cone-shaped mountain." }
      ],
      9: [
        { title: "Saegreifinn", kind: "Restaurant", text: "Harbor seafood stop, known for lobster soup." },
        { title: "Braud & Co Reykjavik", kind: "Cafe", text: "Art-walled bakery with popular cinnamon pastries." },
        { title: "National Museum of Iceland", kind: "Cultural spot", text: "Core museum for Iceland's history and identity." },
        { title: "Sun Voyager Waterfront", kind: "Tourist attraction", text: "Signature sculpture walk on Reykjavik's seafront." }
      ],
      10: [
        { title: "Kaffi Loki", kind: "Restaurant", text: "Traditional Icelandic comfort dishes near Hallgrimskirkja." },
        { title: "Reykjavik Roasters Brautarholt", kind: "Cafe", text: "Specialty coffee stop before/after lagoon sessions." },
        { title: "The Settlement Exhibition Reykjavik 871¬±2", kind: "Cultural spot", text: "Archaeological museum around a preserved Viking longhouse." },
        { title: "Skolavordustigur Rainbow Street", kind: "Tourist attraction", text: "Colorful central street with shops and photo points." }
      ],
      11: [
        { title: "Radhuskaffi Keflavik", kind: "Restaurant", text: "Reliable meal option before airport drop-off." },
        { title: "Kaffi Duus", kind: "Cafe", text: "Harbor-side cafe/restaurant in Keflavik." },
        { title: "Viking World Museum", kind: "Cultural spot", text: "Museum focused on Viking voyages and replicas." },
        { title: "Gunnuhver Geothermal Area", kind: "Tourist attraction", text: "Rugged Reykjanes geothermal stop with steam vents." }
      ]
    };

    const RECOMMENDATION_TITLE_PRICE_OVERRIDES = {
      "hallgrimskirkja": { priceISK: 1500, priceLabel: "Tower ticket" },
      "national museum of iceland": { priceISK: 2500, priceLabel: "Est. adult ticket" },
      "the settlement exhibition reykjavik 871 2": { priceISK: 3000, priceLabel: "Est. adult ticket" },
      "viking world museum": { priceISK: 2500, priceLabel: "Est. adult ticket" },
      "kirkjufell viewpoint": { priceISK: 1200, priceLabel: "Parking (standard car)" },
      "harpa concert hall": { priceISK: 0, priceLabel: "Free access" },
      "skalholt cathedral": { priceISK: 0, priceLabel: "Free access" },
      "vikurkirkja church": { priceISK: 0, priceLabel: "Free access" },
      "akureyri church": { priceISK: 0, priceLabel: "Free access" }
    };

    const RECOMMENDATION_KIND_PRICE_DEFAULTS = {
      "restaurant": { priceISK: 3900, priceLabel: "Avg meal" },
      "cafe": { priceISK: 1400, priceLabel: "Avg order" },
      "cultural spot": { priceISK: 2200, priceLabel: "Est. entry" },
      "tourist attraction": { priceISK: 0, priceLabel: "Free access" },
      "natural spot": { priceISK: 0, priceLabel: "Free access" },
      "activity": { priceISK: 8900, priceLabel: "Est. from listings" },
      "tour": { priceISK: 15900, priceLabel: "Est. from listings" }
    };

    function resolveRecommendationPricing(title, kind, priceISK, priceLabel) {
      let resolvedPriceISK = priceISK;
      let resolvedLabel = priceLabel;

      if (resolvedPriceISK === null) {
        const titleKey = normalizePlaceText(title);
        const titleOverride = RECOMMENDATION_TITLE_PRICE_OVERRIDES[titleKey];
        if (titleOverride) {
          resolvedPriceISK = toNonNegativeInteger(titleOverride.priceISK);
          if (!resolvedLabel) {
            resolvedLabel = String(titleOverride.priceLabel || "").trim();
          }
        }
      }

      if (resolvedPriceISK === null) {
        const kindKey = normalizePlaceText(kind);
        const kindDefault = RECOMMENDATION_KIND_PRICE_DEFAULTS[kindKey];
        if (kindDefault) {
          resolvedPriceISK = toNonNegativeInteger(kindDefault.priceISK);
          if (!resolvedLabel) {
            resolvedLabel = String(kindDefault.priceLabel || "").trim();
          }
        }
      }

      if (resolvedPriceISK === 0 && !resolvedLabel) {
        resolvedLabel = "Free access";
      }
      if (resolvedPriceISK !== null && !resolvedLabel) {
        resolvedLabel = "Estimated";
      }

      return {
        priceISK: resolvedPriceISK,
        priceLabel: resolvedLabel
      };
    }

    const CAMP_PRICE_BOOK = [
      { matches: ["thingvellir", "reykjavik thingvellir"], displayName: "Thingvellir Campsite", perAdultISK: 1800, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["gesthus selfoss"], displayName: "Gesthus Selfoss", perAdultISK: 2900, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["vik campsite", "vik or thakgil", "thakgil"], displayName: "Vik Campsite", perAdultISK: 2100, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["vestrahorn"], displayName: "Vestrahorn Campsite", perAdultISK: 2800, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["egilsstadir"], displayName: "Camp Egilsstadir", perAdultISK: 2750, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["hamrar", "akureyri"], displayName: "Hamrar (Akureyri)", perAdultISK: 2500, unitFeeISK: 500, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["budardalur"], displayName: "Budardalur Campsite", perAdultISK: 2000, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["snorrastadir"], displayName: "Snorrastadir Camp", perAdultISK: 2200, lodgingTaxISK: 400, includeBaseExpense: true },
      { matches: ["home exchange"], displayName: "Home Exchange (Reykjavik)", perAdultISK: 0, includeBaseExpense: false },
      { matches: ["departure"], displayName: "Departure", perAdultISK: 0, includeBaseExpense: false }
    ];

    function normalizeRecommendationItem(item) {
      const rawPriceISK = Number(item && item.priceISK);
      const normalizedPrice = Number.isFinite(rawPriceISK) && rawPriceISK >= 0
        ? Math.round(rawPriceISK)
        : null;
      const title = String((item && item.title) || "Recommendation").trim();
      const text = String((item && item.text) || "").trim();
      const kind = String((item && item.kind) || "Activity").trim();
      const resolvedPricing = resolveRecommendationPricing(
        title,
        kind,
        normalizedPrice,
        String((item && item.priceLabel) || "").trim()
      );

      return {
        title,
        text,
        kind,
        priceISK: resolvedPricing.priceISK,
        priceLabel: resolvedPricing.priceLabel,
        url: String((item && item.url) || "").trim()
      };
    }

    function applyEnhancedRecommendations() {
      days.forEach((day) => {
        const enhanced = Array.isArray(ENHANCED_RECOMMENDATIONS_BY_DAY[day.day])
          ? ENHANCED_RECOMMENDATIONS_BY_DAY[day.day]
          : Array.isArray(day.recommendations)
            ? day.recommendations
            : [];
        const discovery = Array.isArray(DISCOVERY_RECOMMENDATIONS_BY_DAY[day.day])
          ? DISCOVERY_RECOMMENDATIONS_BY_DAY[day.day]
          : [];
        day.recommendations = [...enhanced, ...discovery].map(normalizeRecommendationItem);
      });
    }

    function findCampPriceConfig(campName) {
      const normalizedName = normalizePlaceText(campName);
      if (!normalizedName) {
        return null;
      }
      return (
        CAMP_PRICE_BOOK.find((entry) =>
          Array.isArray(entry.matches) &&
          entry.matches.some((token) => normalizedName.includes(normalizePlaceText(token)))
        ) || null
      );
    }

    function getDayCampPricing(day) {
      const config = findCampPriceConfig(day && day.camp);
      if (!config) {
        return null;
      }

      const adults = Number.isFinite(config.adults) && config.adults > 0
        ? Math.round(config.adults)
        : 2;
      const perAdultISK = Number.isFinite(config.perAdultISK) && config.perAdultISK > 0
        ? Math.round(config.perAdultISK)
        : 0;
      const unitFeeISK = Number.isFinite(config.unitFeeISK) && config.unitFeeISK > 0
        ? Math.round(config.unitFeeISK)
        : 0;
      const lodgingTaxISK = Number.isFinite(config.lodgingTaxISK) && config.lodgingTaxISK > 0
        ? Math.round(config.lodgingTaxISK)
        : 0;

      return {
        displayName: config.displayName || String(day && day.camp ? day.camp : "Campsite"),
        includeBaseExpense: Boolean(config.includeBaseExpense),
        adults,
        perAdultISK,
        unitFeeISK,
        lodgingTaxISK,
        baseExpenseISK: perAdultISK * adults + unitFeeISK + lodgingTaxISK
      };
    }

    applyEnhancedRecommendations();

    const PACK_STORAGE_KEY = "icelandPackListV2";
    const defaultPackItems = [
      "Thermals (merino wool base layers)",
      "Warm mid-layer (fleece/wool sweater)",
      "Waterproof jacket (windproof)",
      "Waterproof pants (essential for waterfalls)",
      "Waterproof hiking boots",
      "Microspikes/Crampons",
      "Warm beanie hat & scarf/buff",
      "Waterproof gloves",
      "Swimsuit & quick-dry towel",
      "Power bank for phones",
      "Lip balm & moisturizer",
      "Headlamp (for campsites)"
    ];

    function loadPackItems() {
      try {
        const raw = localStorage.getItem(PACK_STORAGE_KEY);
        if (!raw) {
          return defaultPackItems.map((text, index) => ({ id: index + 1, text, done: false }));
        }

        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) {
          return defaultPackItems.map((text, index) => ({ id: index + 1, text, done: false }));
        }

        let fallbackId = 1;
        const items = parsed
          .filter((item) => item && (typeof item.text === "string" || typeof item.label === "string"))
          .map((item) => {
            const text = String(item.text ?? item.label).trim().slice(0, 100);
            const rawId = Number(item.id);
            const id = Number.isFinite(rawId) && rawId > 0 ? rawId : fallbackId++;
            return {
              id,
              text,
              done: Boolean(item.done ?? item.checked)
            };
          })
          .filter((item) => item.text.length > 0);

        if (items.length > 0) {
          return items;
        }
        return defaultPackItems.map((text, index) => ({ id: index + 1, text, done: false }));
      } catch {
        return defaultPackItems.map((text, index) => ({ id: index + 1, text, done: false }));
      }
    }

    let packItems = loadPackItems();
    let nextPackId = packItems.length ? Math.max(...packItems.map((item) => item.id)) + 1 : 1;

    const packListEl = document.getElementById("packlist");
    const progressEl = document.getElementById("pack-progress");
    const progLabelEl = document.getElementById("prog-label");
    const progPctEl = document.getElementById("prog-pct");
    const addItemFormEl = document.getElementById("add-item-form");
    const newItemInputEl = document.getElementById("new-item-input");

    function savePackItems() {
      localStorage.setItem(PACK_STORAGE_KEY, JSON.stringify(packItems));
    }

    function updatePackProgress() {
      const total = packItems.length;
      const checked = packItems.filter((item) => item.done).length;
      const ratio = total === 0 ? 0 : (checked / total) * 100;
      progressEl.style.width = ratio + "%";
      progLabelEl.textContent = checked + " / " + total + " packed";
      progPctEl.textContent = Math.round(ratio) + "%";
    }

    function renderPackList() {
      packListEl.innerHTML = "";

      packItems.forEach((item) => {
        const row = document.createElement("div");
        row.className = "pack-item";
        row.dataset.id = String(item.id);

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.done;
        checkbox.setAttribute("aria-label", "Mark item packed");

        const label = document.createElement("span");
        label.className = "pack-label" + (item.done ? " done" : "");
        label.textContent = item.text;

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "act-btn";
        editBtn.type = "button";
        editBtn.title = "Edit item";
        editBtn.setAttribute("aria-label", "Edit item");
        editBtn.innerHTML = "<svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/><path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/></svg>";

        const removeBtn = document.createElement("button");
        removeBtn.className = "act-btn del";
        removeBtn.type = "button";
        removeBtn.title = "Remove item";
        removeBtn.setAttribute("aria-label", "Remove item");
        removeBtn.innerHTML = "<svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6\"/><path d=\"M10 11v6M14 11v6\"/><path d=\"M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2\"/></svg>";

        checkbox.addEventListener("change", () => {
          item.done = checkbox.checked;
          savePackItems();
          renderPackList();
        });

        editBtn.addEventListener("click", () => {
          startPackItemEdit(item.id);
        });

        removeBtn.addEventListener("click", () => {
          packItems = packItems.filter((entry) => entry.id !== item.id);
          savePackItems();
          renderPackList();
        });

        label.addEventListener("dblclick", () => {
          startPackItemEdit(item.id);
        });

        actions.appendChild(editBtn);
        actions.appendChild(removeBtn);

        row.appendChild(checkbox);
        row.appendChild(label);
        row.appendChild(actions);
        packListEl.appendChild(row);
      });

      updatePackProgress();
    }

    function startPackItemEdit(id) {
      const item = packItems.find((entry) => entry.id === id);
      const row = packListEl.querySelector('[data-id="' + id + '"]');
      if (!item || !row) {
        return;
      }

      const label = row.querySelector(".pack-label");
      const actions = row.querySelector(".item-actions");
      if (!label || !actions) {
        return;
      }

      const input = document.createElement("input");
      input.type = "text";
      input.className = "pack-edit-input";
      input.value = item.text;
      input.maxLength = 100;

      label.replaceWith(input);
      actions.style.visibility = "hidden";
      input.focus();
      input.select();

      const commit = () => {
        const value = input.value.trim();
        if (value) {
          item.text = value;
          savePackItems();
        }
        renderPackList();
      };

      input.addEventListener("blur", commit);
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          input.blur();
        }
        if (event.key === "Escape") {
          renderPackList();
        }
      });
    }

    addItemFormEl.addEventListener("submit", (event) => {
      event.preventDefault();
      const value = newItemInputEl.value.trim().slice(0, 100);
      if (!value) {
        return;
      }
      packItems.push({ id: nextPackId++, text: value, done: false });
      savePackItems();
      renderPackList();
      newItemInputEl.value = "";
      newItemInputEl.focus();
    });

    const BUDGET_STORAGE_KEY = "icelandBudgetV1";
    const FX_STORAGE_KEY = "icelandFxIskEurV1";
    const FX_API_URL = "https://open.er-api.com/v6/latest/ISK";
    const DEFAULT_ISK_TO_EUR_RATE = 0.0069;

    function toNonNegativeInteger(value) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric < 0) {
        return 0;
      }
      return Math.round(numeric);
    }

    function formatISKAmount(iskAmount) {
      return (
        new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 }).format(
          toNonNegativeInteger(iskAmount)
        ) + " ISK"
      );
    }

    function formatEURAmount(eurAmount) {
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(Number.isFinite(eurAmount) ? eurAmount : 0);
    }

    function loadBudgetState() {
      try {
        const raw = localStorage.getItem(BUDGET_STORAGE_KEY);
        if (!raw) {
          return { maxBudgetISK: 0, expenses: [] };
        }

        const parsed = JSON.parse(raw);
        const maxBudgetISK = toNonNegativeInteger(parsed && parsed.maxBudgetISK);
        const expenses = Array.isArray(parsed && parsed.expenses)
          ? parsed.expenses
              .filter((item) => item && typeof item.name === "string")
              .map((item, index) => ({
                id: Number.isFinite(Number(item.id)) ? Number(item.id) : index + 1,
                name: item.name.trim().slice(0, 100),
                amountISK: toNonNegativeInteger(item.amountISK)
              }))
              .filter((item) => item.name.length > 0)
          : [];

        return { maxBudgetISK, expenses };
      } catch {
        return { maxBudgetISK: 0, expenses: [] };
      }
    }

    function saveBudgetState() {
      localStorage.setItem(
        BUDGET_STORAGE_KEY,
        JSON.stringify({
          maxBudgetISK: budgetState.maxBudgetISK,
          expenses: budgetState.expenses
        })
      );
    }

    function loadFxState() {
      try {
        const raw = localStorage.getItem(FX_STORAGE_KEY);
        if (!raw) {
          return {
            rate: DEFAULT_ISK_TO_EUR_RATE,
            updatedAt: null
          };
        }
        const parsed = JSON.parse(raw);
        const rate = Number(parsed && parsed.rate);
        const updatedAt = Number(parsed && parsed.updatedAt);
        return {
          rate: Number.isFinite(rate) && rate > 0 ? rate : DEFAULT_ISK_TO_EUR_RATE,
          updatedAt: Number.isFinite(updatedAt) ? updatedAt : null
        };
      } catch {
        return {
          rate: DEFAULT_ISK_TO_EUR_RATE,
          updatedAt: null
        };
      }
    }

    function saveFxState() {
      localStorage.setItem(
        FX_STORAGE_KEY,
        JSON.stringify({
          rate: fxState.rate,
          updatedAt: fxState.updatedAt
        })
      );
    }

    let budgetState = loadBudgetState();
    let nextExpenseId = budgetState.expenses.length
      ? Math.max(...budgetState.expenses.map((item) => item.id)) + 1
      : 1;
    let fxState = loadFxState();

    const budgetMainEl = document.getElementById("budget-main");
    const budgetPercentEl = document.getElementById("budget-percent");
    const budgetEurEl = document.getElementById("budget-eur");
    const budgetProgressEl = document.getElementById("budget-progress");
    const budgetRateEl = document.getElementById("budget-rate");
    const budgetBaseNoteEl = document.getElementById("budget-base-note");
    const budgetMaxFormEl = document.getElementById("budget-max-form");
    const budgetMaxInputEl = document.getElementById("budget-max-input");
    const expenseFormEl = document.getElementById("expense-form");
    const expenseNameInputEl = document.getElementById("expense-name-input");
    const expenseAmountInputEl = document.getElementById("expense-amount-input");
    const budgetListEl = document.getElementById("budget-list");
    const budgetCalcInputEl = document.getElementById("budget-calc-isk-input");
    const budgetCalcOutputEl = document.getElementById("budget-calc-output");

    function eurFromISK(iskAmount) {
      return toNonNegativeInteger(iskAmount) * fxState.rate;
    }

    function isBookingRecommendation(recommendation) {
      const kind = normalizePlaceText(recommendation && recommendation.kind);
      return kind.includes("tour") || kind.includes("activity");
    }

    function getRecommendationLink(recommendation) {
      const explicitUrl = recommendation && typeof recommendation.url === "string"
        ? recommendation.url.trim()
        : "";
      if (explicitUrl) {
        return explicitUrl;
      }

      const title = String((recommendation && recommendation.title) || "Iceland").trim();
      if (isBookingRecommendation(recommendation)) {
        return bookingSearchUrl(title + " Iceland");
      }
      return mapsSearchUrl(title + ", Iceland");
    }

    function getRecommendationActionLabel(recommendation) {
      return isBookingRecommendation(recommendation) ? "Book activity" : "Open in Maps";
    }

    function getRecommendationPriceText(recommendation) {
      const priceISK = recommendation && Number.isFinite(recommendation.priceISK)
        ? Math.max(0, Math.round(recommendation.priceISK))
        : null;

      if (priceISK === null) {
        return "Price pending";
      }
      if (priceISK === 0) {
        return "Free";
      }

      const prefix = recommendation && recommendation.priceLabel
        ? recommendation.priceLabel.trim() + " "
        : "";
      return (
        prefix +
        formatISKAmount(priceISK) +
        " ¬∑ " +
        formatEURAmount(eurFromISK(priceISK))
      );
    }

    function getCampPriceDisplayText(campPricing) {
      if (!campPricing) {
        return "price unavailable";
      }
      if (!Number.isFinite(campPricing.perAdultISK) || campPricing.perAdultISK <= 0) {
        return campPricing.includeBaseExpense ? "price unavailable" : "included stay";
      }
      return (
        "from " +
        formatISKAmount(campPricing.perAdultISK) +
        " ¬∑ " +
        formatEURAmount(eurFromISK(campPricing.perAdultISK)) +
        " / adult"
      );
    }

    function getCampsiteBaseExpenses() {
      return days
        .map((day) => {
          const pricing = getDayCampPricing(day);
          if (!pricing || !pricing.includeBaseExpense || !pricing.baseExpenseISK) {
            return null;
          }
          return {
            key: "camp-base-" + day.day,
            name: "Day " + day.day + " campsite - " + pricing.displayName,
            amountISK: pricing.baseExpenseISK
          };
        })
        .filter(Boolean);
    }

    function renderFxRateLabel(isLoading = false) {
      const formattedRate = "‚Ç¨" + fxState.rate.toFixed(5);
      budgetRateEl.classList.toggle("loading", Boolean(isLoading));
      const isStale =
        !fxState.updatedAt || Date.now() - fxState.updatedAt > 36 * 60 * 60 * 1000;
      budgetRateEl.classList.toggle("stale", isStale);

      if (isLoading) {
        budgetRateEl.textContent = "Updating ISK‚ÜíEUR daily rate‚Ä¶";
        return;
      }

      if (fxState.updatedAt) {
        const dateLabel = new Date(fxState.updatedAt).toLocaleDateString();
        budgetRateEl.textContent =
          "Rate: 1 ISK = " + formattedRate + " ¬∑ updated " + dateLabel;
      } else {
        budgetRateEl.textContent =
          "Rate: 1 ISK = " + formattedRate + " ¬∑ fallback rate";
      }
    }

    function renderBudgetCalculator() {
      const inputISK = toNonNegativeInteger(budgetCalcInputEl.value);
      budgetCalcOutputEl.textContent = formatEURAmount(eurFromISK(inputISK));
    }

    function renderBudgetList() {
      budgetListEl.innerHTML = "";
      const baseExpenses = getCampsiteBaseExpenses();
      const hasUserExpenses = budgetState.expenses.length > 0;

      if (!baseExpenses.length && !hasUserExpenses) {
        const empty = document.createElement("p");
        empty.className = "muted";
        empty.textContent = "No expenses yet. Add one above.";
        budgetListEl.appendChild(empty);
        return;
      }

      baseExpenses.forEach((expense) => {
        const row = document.createElement("div");
        row.className = "expense-item base-expense";
        row.dataset.expenseId = expense.key;
        row.innerHTML =
          "<div class=\"expense-main-wrap\">" +
            "<div class=\"expense-name\">" + escapeHtml(expense.name) + "</div>" +
            "<div class=\"expense-meta\">" +
              "<div class=\"expense-eur\">" + formatEURAmount(eurFromISK(expense.amountISK)) + "</div>" +
              "<span class=\"expense-base-pill\">üîí Base</span>" +
            "</div>" +
          "</div>" +
          "<div class=\"expense-isk\">" + formatISKAmount(expense.amountISK) + "</div>";

        budgetListEl.appendChild(row);
      });

      budgetState.expenses.forEach((expense) => {
        const row = document.createElement("div");
        row.className = "expense-item";
        row.dataset.expenseId = String(expense.id);
        row.innerHTML =
          "<div class=\"expense-main-wrap\">" +
            "<div class=\"expense-name\">" + escapeHtml(expense.name) + "</div>" +
            "<div class=\"expense-eur\">" + formatEURAmount(eurFromISK(expense.amountISK)) + "</div>" +
          "</div>" +
          "<div class=\"expense-isk\">" + formatISKAmount(expense.amountISK) + "</div>" +
          "<div class=\"item-actions\" style=\"opacity:1; margin-left:8px;\">" +
            "<button class=\"act-btn\" type=\"button\" data-action=\"edit\" title=\"Edit expense\" aria-label=\"Edit expense\">" +
              "<svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/><path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/></svg>" +
            "</button>" +
            "<button class=\"act-btn del\" type=\"button\" data-action=\"del\" title=\"Remove expense\" aria-label=\"Remove expense\">" +
              "<svg width=\"13\" height=\"13\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6\"/><path d=\"M10 11v6M14 11v6\"/><path d=\"M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2\"/></svg>" +
            "</button>" +
          "</div>";

        const editBtn = row.querySelector('[data-action="edit"]');
        const delBtn = row.querySelector('[data-action="del"]');

        editBtn.addEventListener("click", () => {
          const nextName = window.prompt("Expense name", expense.name);
          if (nextName === null) {
            return;
          }
          const normalizedName = nextName.trim().slice(0, 100);
          if (!normalizedName) {
            return;
          }

          const nextAmountRaw = window.prompt("Amount in ISK", String(expense.amountISK));
          if (nextAmountRaw === null) {
            return;
          }
          const nextAmount = toNonNegativeInteger(nextAmountRaw);
          if (!nextAmount) {
            return;
          }

          expense.name = normalizedName;
          expense.amountISK = nextAmount;
          saveBudgetState();
          renderBudgetCard();
        });

        delBtn.addEventListener("click", () => {
          budgetState.expenses = budgetState.expenses.filter((item) => item.id !== expense.id);
          saveBudgetState();
          renderBudgetCard();
        });

        budgetListEl.appendChild(row);
      });
    }

    function renderBudgetCard() {
      const baseExpenses = getCampsiteBaseExpenses();
      const baseISK = baseExpenses.reduce(
        (sum, expense) => sum + toNonNegativeInteger(expense.amountISK),
        0
      );
      const variableISK = budgetState.expenses.reduce(
        (sum, expense) => sum + toNonNegativeInteger(expense.amountISK),
        0
      );
      const spentISK = baseISK + variableISK;
      const maxISK = toNonNegativeInteger(budgetState.maxBudgetISK);
      const spentEUR = eurFromISK(spentISK);
      const maxEUR = eurFromISK(maxISK);
      const ratio = maxISK > 0 ? Math.round((spentISK / maxISK) * 100) : 0;
      const progressRatio = maxISK > 0 ? Math.min(100, ratio) : 0;

      budgetMainEl.textContent =
        formatISKAmount(spentISK) + " / " + formatISKAmount(maxISK);
      budgetPercentEl.textContent = maxISK > 0 ? ratio + "%" : "0%";
      budgetEurEl.textContent = formatEURAmount(spentEUR) + " / " + formatEURAmount(maxEUR);
      budgetMainEl.classList.toggle("over", maxISK > 0 && spentISK > maxISK);
      budgetPercentEl.classList.toggle("over", maxISK > 0 && spentISK > maxISK);
      budgetProgressEl.style.width = progressRatio + "%";
      budgetProgressEl.style.background =
        maxISK > 0 && spentISK > maxISK ? "#dc2626" : "var(--success-ui)";

      if (document.activeElement !== budgetMaxInputEl) {
        budgetMaxInputEl.value = maxISK ? String(maxISK) : "";
      }

      budgetBaseNoteEl.textContent = baseISK
        ? "Includes campsite base expenses: " + formatISKAmount(baseISK) + " ¬∑ " + formatEURAmount(eurFromISK(baseISK))
        : "";

      renderBudgetList();
      renderBudgetCalculator();
      renderFxRateLabel(false);
    }

    async function refreshIskEurRate() {
      renderFxRateLabel(true);
      try {
        const response = await fetch(FX_API_URL, {
          headers: { Accept: "application/json" }
        });
        if (!response.ok) {
          throw new Error("FX API status " + response.status);
        }

        const data = await response.json();
        const nextRate = Number(data && data.rates && data.rates.EUR);
        const nextUpdatedAt = Number(data && data.time_last_update_unix);
        if (!Number.isFinite(nextRate) || nextRate <= 0) {
          throw new Error("Invalid EUR rate in response");
        }

        fxState.rate = nextRate;
        fxState.updatedAt = Number.isFinite(nextUpdatedAt)
          ? nextUpdatedAt * 1000
          : Date.now();
        saveFxState();
      } catch (error) {
        console.warn("FX refresh failed", error);
      } finally {
        renderBudgetCard();
      }
    }

    budgetMaxFormEl.addEventListener("submit", (event) => {
      event.preventDefault();
      budgetState.maxBudgetISK = toNonNegativeInteger(budgetMaxInputEl.value);
      saveBudgetState();
      renderBudgetCard();
    });

    expenseFormEl.addEventListener("submit", (event) => {
      event.preventDefault();
      const name = expenseNameInputEl.value.trim().slice(0, 100);
      const amountISK = toNonNegativeInteger(expenseAmountInputEl.value);
      if (!name || !amountISK) {
        return;
      }

      budgetState.expenses.push({
        id: nextExpenseId++,
        name,
        amountISK
      });
      saveBudgetState();
      renderBudgetCard();
      expenseNameInputEl.value = "";
      expenseAmountInputEl.value = "";
      expenseNameInputEl.focus();
    });

    budgetCalcInputEl.addEventListener("input", renderBudgetCalculator);

    const daysContainerEl = document.getElementById("days-container");

    function createDayCard(day, color) {
      const details = document.createElement("details");
      details.className = "day-card";
      details.dataset.day = String(day.day);
      details.style.setProperty("--day-color", color);

      const routePoints = getDayRoutePoints(day);
      const locations = getDisplayLocations(day, routePoints);
      const visitsHTML = locations
        .map((location, index) => {
          const locationUrl = locationMapsUrl(location, routePoints[index]);
          const prefix = location.isCampsite ? "üè† " : "";
          return "<li><a class=\"location-link-inline\" href=\"" + locationUrl + "\" target=\"_blank\" rel=\"noopener noreferrer\">" + prefix + escapeHtml(location.name) + "</a></li>";
        })
        .join("");
      const campPricing = getDayCampPricing(day);
      const campPriceText = campPricing ? getCampPriceDisplayText(campPricing) : "price unavailable";
      const recosHTML = day.recommendations
        .map((rec) => {
          const recommendationUrl = getRecommendationLink(rec);
          const actionLabel = getRecommendationActionLabel(rec);
          return (
          "<li>" +
            "<a class=\"location-link-inline\" href=\"" + escapeHtml(recommendationUrl) + "\" target=\"_blank\" rel=\"noopener noreferrer\">" +
              escapeHtml(rec.title) +
            "</a>" +
            " <span class=\"muted\">(" +
            escapeHtml(rec.kind || "Activity") +
            " ¬∑ " +
            escapeHtml(getRecommendationPriceText(rec)) +
            " ¬∑ " +
            escapeHtml(actionLabel) +
            ")</span>" +
          "</li>"
        );
        })
        .join("");

      details.innerHTML =
        "<summary>" +
          "<div class=\"day-heading\">" +
            "<span class=\"day-number\">" + day.day + "</span>" +
            "<span class=\"day-title\">" + day.title + "</span>" +
          "</div>" +
          "<button class=\"btn btn-ghost fullscreen-trigger\" type=\"button\" aria-label=\"Open Day " + day.day + " fullscreen\"><span class=\"open-icon\" aria-hidden=\"true\">‚Üó</span><span>Open</span></button>" +
        "</summary>" +
        "<div class=\"day-content\">" +
          "<div class=\"meta-row\">" +
            "<span class=\"tag day-drive-tag\" data-day-drive=\"" + day.day + "\">üöó <span class=\"drive-main\">" + escapeHtml(day.drive) + "</span></span>" +
            "<span class=\"tag\">‚õ∫ " + escapeHtml(day.camp) + " ¬∑ " + escapeHtml(campPriceText) + "</span>" +
          "</div>" +
          "<a class=\"map-link\" href=\"" + day.mapLink + "\" target=\"_blank\" rel=\"noopener noreferrer\">üìç Open Route Map</a>" +
          "<h4>Route &amp; Visits</h4>" +
          "<ul>" + visitsHTML + "</ul>" +
          "<h4>Recommendations</h4>" +
          "<ul>" + recosHTML + "</ul>" +
        "</div>";

      return details;
    }

    days.forEach((day, index) => {
      const color = dayColors[index % dayColors.length];
      daysContainerEl.appendChild(createDayCard(day, color));
    });

    const allDayCards = Array.from(document.querySelectorAll(".day-card"));
    const appHeaderEl = document.querySelector(".app-header");
    const HEADER_COMPACT_ENTER_Y = 64;
    const HEADER_COMPACT_EXIT_Y = 2;
    let isHeaderCompact = false;
    let headerScrollRaf = 0;

    function getStickyHeaderHeight() {
      return appHeaderEl ? Math.ceil(appHeaderEl.getBoundingClientRect().height) : 0;
    }

    function scrollDayCardIntoView(detail) {
      if (!detail) {
        return;
      }
      const topMargin = 10;
      const offset = getStickyHeaderHeight() + topMargin;
      const targetY = Math.max(
        0,
        Math.round(window.scrollY + detail.getBoundingClientRect().top - offset)
      );
      window.scrollTo({ top: targetY, left: 0, behavior: "smooth" });
    }

    function updateHeaderCompactState() {
      if (!appHeaderEl) {
        return;
      }

      const scrollY = Math.max(
        0,
        window.scrollY || document.documentElement.scrollTop || 0
      );
      if (!isHeaderCompact && scrollY >= HEADER_COMPACT_ENTER_Y) {
        isHeaderCompact = true;
      } else if (isHeaderCompact && scrollY <= HEADER_COMPACT_EXIT_Y) {
        isHeaderCompact = false;
      }

      appHeaderEl.classList.toggle("compact", isHeaderCompact);
    }

    function scheduleHeaderCompactUpdate() {
      if (headerScrollRaf) {
        return;
      }
      headerScrollRaf = window.requestAnimationFrame(() => {
        headerScrollRaf = 0;
        updateHeaderCompactState();
      });
    }

    window.addEventListener("scroll", scheduleHeaderCompactUpdate, { passive: true });
    window.addEventListener("resize", updateHeaderCompactState);

    allDayCards.forEach((detail) => {
      detail.addEventListener("toggle", (event) => {
        if (!detail.open) {
          return;
        }
        allDayCards.forEach((other) => {
          if (other !== detail) {
            other.open = false;
          }
        });
        if (event.isTrusted) {
          requestAnimationFrame(() => {
            scrollDayCardIntoView(detail);
          });
        }
      });
    });

    const departureCountdownCardEl = document.getElementById("departure-countdown-card");
    const departureCountdownDaysEl = document.getElementById("departure-countdown-days");
    const departureCountdownTimeEl = document.getElementById("departure-countdown-time");
    const flightCardEl = document.getElementById("flight-card");
    const outboundFlightBlockEl = document.getElementById("outbound-flight-block");
    const daysSectionTitleEl = document.getElementById("days-section-title");
    const packingCardEl = document.getElementById("packing-card");
    const fxCardEl = document.getElementById("fx-card");
    const usefulLinksCardEl = document.getElementById("useful-links-card");
    const budgetCardViewEl = document.getElementById("budget-card");
    const tabButtons = Array.from(document.querySelectorAll(".tab-btn"));

    if (budgetCardViewEl && packingCardEl) {
      budgetCardViewEl.insertAdjacentElement("afterend", packingCardEl);
    }
    if (packingCardEl && usefulLinksCardEl) {
      packingCardEl.insertAdjacentElement("afterend", usefulLinksCardEl);
    }

    const TRIP_START_DATE = new Date(2026, 2, 4);
    const TRIP_END_DATE = new Date(2026, 2, 14);
    const OUTBOUND_DEPARTURE_DATE = new Date("2026-03-04T14:25:00+01:00");
    const COUNTDOWN_HIDE_DATE = new Date("2026-03-05T00:00:00+00:00");
    const OUTBOUND_HIDE_DATE = new Date("2026-03-04T17:15:00+00:00");
    let activeTab = "home";

    function startOfLocalDay(dateValue) {
      const date = new Date(dateValue);
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function getTripPhaseAndDay(now = new Date()) {
      const today = startOfLocalDay(now);
      const tripStart = startOfLocalDay(TRIP_START_DATE);
      const tripEnd = startOfLocalDay(TRIP_END_DATE);

      if (today < tripStart) {
        return { phase: "before", dayNumber: 1 };
      }

      const rawDayNumber =
        Math.floor((today.getTime() - tripStart.getTime()) / (24 * 60 * 60 * 1000)) + 1;
      const boundedDayNumber = Math.min(days.length, Math.max(1, rawDayNumber));

      if (today > tripEnd) {
        return { phase: "after", dayNumber: days.length };
      }
      return { phase: "during", dayNumber: boundedDayNumber };
    }

    function setElementVisibility(element, visible) {
      if (!element) {
        return;
      }
      element.style.display = visible ? "" : "none";
    }

    function showAllDayCards() {
      allDayCards.forEach((card) => {
        card.style.display = "";
      });
    }

    function showSingleDayCard(dayNumber) {
      allDayCards.forEach((card) => {
        const cardDay = Number(card.dataset.day);
        const isTarget = cardDay === dayNumber;
        card.style.display = isTarget ? "" : "none";
        card.open = Boolean(isTarget);
      });
    }

    function setActiveTabButton(nextTab) {
      tabButtons.forEach((button) => {
        const isActive = button.dataset.tab === nextTab;
        button.classList.toggle("active", isActive);
        button.setAttribute("aria-selected", isActive ? "true" : "false");
      });
    }

    function scrollPageToTop() {
      window.scrollTo({ top: 0, left: 0, behavior: "auto" });
    }

    function updateDepartureCountdown() {
      if (!departureCountdownDaysEl || !departureCountdownTimeEl) {
        return;
      }

      const now = Date.now();
      const diffMs = OUTBOUND_DEPARTURE_DATE.getTime() - now;

      if (diffMs <= 0) {
        departureCountdownDaysEl.textContent = "Let the adventure begin !";
        departureCountdownTimeEl.textContent = "";
        return;
      }

      const safeDiffMs = Math.max(0, diffMs);
      const totalMinutes = Math.floor(safeDiffMs / 60000);
      const days = Math.floor(totalMinutes / (24 * 60));
      const hours = Math.floor((totalMinutes % (24 * 60)) / 60);
      const minutes = totalMinutes % 60;
      const dayLabel = days === 1 ? "day" : "days";

      departureCountdownDaysEl.textContent = days + " " + dayLabel;
      departureCountdownTimeEl.textContent =
        String(hours).padStart(2, "0") + "h " + String(minutes).padStart(2, "0") + "m";
    }

    function updateTimeAwareVisibility() {
      const now = Date.now();
      const shouldShowCountdown = activeTab === "home" && now < COUNTDOWN_HIDE_DATE.getTime();
      setElementVisibility(departureCountdownCardEl, shouldShowCountdown);
      if (appHeaderEl) {
        appHeaderEl.classList.toggle("home-hero", shouldShowCountdown);
      }

      const hideOutbound = now >= OUTBOUND_HIDE_DATE.getTime();
      if (outboundFlightBlockEl) {
        outboundFlightBlockEl.style.display = hideOutbound ? "none" : "";
      }
      if (flightCardEl) {
        flightCardEl.classList.toggle("outbound-hidden", hideOutbound);
      }
    }

    function applyTabView(nextTab) {
      const trip = getTripPhaseAndDay();
      activeTab = nextTab;
      setActiveTabButton(nextTab);

      if (nextTab === "itinerary") {
        setElementVisibility(departureCountdownCardEl, false);
        setElementVisibility(flightCardEl, true);
        setElementVisibility(packingCardEl, false);
        setElementVisibility(fxCardEl, false);
        setElementVisibility(usefulLinksCardEl, false);
        setElementVisibility(budgetCardViewEl, false);
        setElementVisibility(daysSectionTitleEl, true);
        setElementVisibility(daysContainerEl, true);
        daysSectionTitleEl.textContent = "Itinerary Days";
        showAllDayCards();
        updateTimeAwareVisibility();
        return;
      }

      if (nextTab === "tools") {
        setElementVisibility(departureCountdownCardEl, false);
        setElementVisibility(flightCardEl, false);
        setElementVisibility(packingCardEl, true);
        setElementVisibility(fxCardEl, true);
        setElementVisibility(usefulLinksCardEl, true);
        setElementVisibility(budgetCardViewEl, true);
        setElementVisibility(daysSectionTitleEl, false);
        setElementVisibility(daysContainerEl, false);
        updateTimeAwareVisibility();
        return;
      }

      if (trip.phase === "before") {
        setElementVisibility(departureCountdownCardEl, true);
        setElementVisibility(flightCardEl, true);
        setElementVisibility(packingCardEl, true);
        setElementVisibility(fxCardEl, false);
        setElementVisibility(usefulLinksCardEl, false);
        setElementVisibility(budgetCardViewEl, false);
        setElementVisibility(daysSectionTitleEl, false);
        setElementVisibility(daysContainerEl, false);
        showAllDayCards();
        updateTimeAwareVisibility();
        return;
      }

      setElementVisibility(departureCountdownCardEl, true);
      setElementVisibility(flightCardEl, false);
      setElementVisibility(packingCardEl, false);
      setElementVisibility(fxCardEl, false);
      setElementVisibility(usefulLinksCardEl, false);
      setElementVisibility(budgetCardViewEl, false);
      setElementVisibility(daysSectionTitleEl, true);
      setElementVisibility(daysContainerEl, true);

      const todayDay = days.find((entry) => entry.day === trip.dayNumber);
      if (trip.phase === "after") {
        daysSectionTitleEl.textContent = "Last Trip Day";
      } else {
        daysSectionTitleEl.textContent = "Today";
      }
      if (todayDay) {
        daysSectionTitleEl.textContent += " ¬∑ Day " + todayDay.day + ": " + todayDay.title;
      }
      showSingleDayCard(trip.dayNumber);
      updateTimeAwareVisibility();
    }

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        if (modalEl.classList.contains("open")) {
          closeDayFullscreen();
        }
        applyTabView(button.dataset.tab || "home");
        scrollPageToTop();
      });
    });

    updateDepartureCountdown();
    updateTimeAwareVisibility();
    setInterval(updateDepartureCountdown, 60 * 1000);
    setInterval(updateTimeAwareVisibility, 60 * 1000);

    const modalEl = document.getElementById("fullscreen-modal");
    const modalHeadEl = document.getElementById("fullscreen-head");
    const modalTitleEl = document.getElementById("fullscreen-title");
    const modalSubtitleEl = document.getElementById("fullscreen-subtitle");
    const modalMapEl = document.getElementById("fullscreen-map");
    const modalMapLinkEl = document.getElementById("fullscreen-map-link");
    const modalRouteEl = document.getElementById("fullscreen-route");
    const modalItineraryEl = document.getElementById("fullscreen-itinerary");
    const modalRecoEl = document.getElementById("fullscreen-reco");
    const closeModalBtnEl = document.getElementById("close-fullscreen");
    const modalBodyEl = modalEl.querySelector(".fullscreen-body");

    let fullscreenMap = null;
    let mapRouteLayer = null;
    let mapMarkersLayer = null;
    let driveTimesRequestId = 0;
    let activeFullscreenDay = null;

    function resolveDayColorHex(dayNumber) {
      return getComputedStyle(document.documentElement)
        .getPropertyValue("--day-" + dayNumber)
        .trim() || "#2563eb";
    }

    function ensureFullscreenMap() {
      if (fullscreenMap || typeof L === "undefined") {
        return;
      }
      fullscreenMap = L.map(modalMapEl, {
        zoomControl: true,
        attributionControl: true
      });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(fullscreenMap);
    }

    function renderFullscreenMap(day, colorHex) {
      ensureFullscreenMap();
      if (!fullscreenMap) {
        return;
      }

      if (mapRouteLayer) {
        fullscreenMap.removeLayer(mapRouteLayer);
        mapRouteLayer = null;
      }
      if (mapMarkersLayer) {
        fullscreenMap.removeLayer(mapMarkersLayer);
        mapMarkersLayer = null;
      }

      const route = getDayRoutePoints(day);
      const locations = getDisplayLocations(day, route);

      if (!route.length) {
        fullscreenMap.setView([64.9, -19.0], 6);
        setTimeout(() => fullscreenMap.invalidateSize(), 0);
        return;
      }

      mapRouteLayer = L.polyline(route, {
        color: colorHex,
        weight: 4,
        opacity: 0.9
      }).addTo(fullscreenMap);

      mapMarkersLayer = L.layerGroup().addTo(fullscreenMap);
      route.forEach((point, index) => {
        const location = locations[index] || null;
        const locationName = location ? location.name : "Stop " + (index + 1);
        const markerColor = location && location.isCampsite ? "#1d4ed8" : colorHex;
        const markerRadius = location && location.isCampsite ? 7 : 6;
        L.circleMarker(point, {
          radius: markerRadius,
          color: "#ffffff",
          weight: 2,
          fillColor: markerColor,
          fillOpacity: 1
        })
          .addTo(mapMarkersLayer)
          .bindPopup((index + 1) + ". " + (location && location.isCampsite ? "üè† " : "") + locationName);
      });

      fullscreenMap.fitBounds(mapRouteLayer.getBounds(), { padding: [30, 30] });
      setTimeout(() => fullscreenMap.invalidateSize(), 0);
    }

    function renderRouteStops(day, color) {
      const routePoints = getDayRoutePoints(day);
      const locations = getDisplayLocations(day, routePoints);
      modalRouteEl.innerHTML = locations
        .map((location, index) => {
          const locationUrl = locationMapsUrl(location, routePoints[index]);
          const stopClass = "route-stop" + (location.isCampsite ? " campsite-stop" : "");
          const stopLabel = (location.isCampsite ? "üè† " : "") + escapeHtml(location.name);
          return (
            "<a class=\"" + stopClass + "\" href=\"" + locationUrl + "\" target=\"_blank\" rel=\"noopener noreferrer\">" +
              "<span class=\"route-dot\" style=\"--route-color:" + color + "\"></span>" +
              stopLabel +
            "</a>"
          );
        })
        .join("");
    }

    function renderItinerary(day, color, driveLegSummaries = [], isLoading = false) {
      const routePoints = getDayRoutePoints(day);
      const locations = getDisplayLocations(day, routePoints);
      const dayCampPricing = getDayCampPricing(day);
      let html = "";

      locations.forEach((location, index) => {
        const locationUrl = locationMapsUrl(location, routePoints[index]);
        const cardClass = "location-card" + (location.isCampsite ? " campsite-card" : "");
        const iconPrefix = location.isCampsite ? "<span class=\"stop-icon\">üè†</span>" : "";
        const locationName = escapeHtml(location.name);
        const locationNote = escapeHtml(location.note);
        const locationPrimaryLabel = location.isCampsite ? "Open campsite in Maps" : "Open location in Maps";
        const campPriceLine = location.isCampsite && dayCampPricing
          ? "<p class=\"location-note\">üí≥ " + escapeHtml(getCampPriceDisplayText(dayCampPricing)) + "</p>"
          : "";
        const discoveryLinksHtml = getLocationDiscoveryLinks(location)
          .map((entry) => (
            "<a class=\"discovery-link\" href=\"" + escapeHtml(entry.url) + "\" target=\"_blank\" rel=\"noopener noreferrer\">" +
              escapeHtml(entry.label) +
            "</a>"
          ))
          .join("");
        const imageKey = getLocationImageCacheKey(day.day, index, location.name);
        const imageSrc = escapeHtml(location.image);
        const loremFallbackSrc = escapeHtml(loremImageFor(location.name, day.day * 1000 + index + 1));
        const cachedImageSrc = getCachedImageUrl(imageKey);
        const cachedImageAttr = cachedImageSrc
          ? " data-cached-src=\"" + escapeHtml(cachedImageSrc) + "\""
          : "";

        html +=
          "<article class=\"itinerary-item\">" +
            "<div class=\"itinerary-rail\">" +
              "<span class=\"itinerary-dot\" style=\"--itinerary-color:" + color + "\"></span>" +
            "</div>" +
            "<div class=\"" + cardClass + "\">" +
                "<h5 class=\"location-name\">" +
                  "<a class=\"location-title-link\" href=\"" + locationUrl + "\" target=\"_blank\" rel=\"noopener noreferrer\" aria-label=\"" + escapeHtml(locationPrimaryLabel) + "\">" +
                    (index + 1) + ". " + iconPrefix + locationName +
                  "</a>" +
                "</h5>" +
                "<p class=\"location-note\">" + locationNote + "</p>" +
                campPriceLine +
                "<div class=\"location-discovery-links\">" + discoveryLinksHtml + "</div>" +
                "<div class=\"location-media loading\">" +
                  "<div class=\"image-loader\" aria-hidden=\"true\"></div>" +
                  "<img class=\"location-image\" loading=\"lazy\" src=\"" + imageSrc + "\" alt=\"" + locationName + " photo\" data-image-key=\"" + escapeHtml(imageKey) + "\" data-location-name=\"" + locationName + "\" data-day-number=\"" + day.day + "\" data-stop-index=\"" + index + "\"" + cachedImageAttr + " data-lorem-src=\"" + loremFallbackSrc + "\" data-fallback-seed=\"" + day.day + "-" + (index + 1) + "\" onload=\"imageLoaded(event)\" onerror=\"imageFallback(event)\">" +
                  "<button class=\"img-refresh-btn\" type=\"button\" onclick=\"refetchLocationImage(this)\" aria-label=\"Refresh photo for " + locationName + "\" title=\"Fetch another photo\">‚Üª New photo</button>" +
                "</div>" +
            "</div>" +
          "</article>";

        if (index < locations.length - 1) {
          const legSummary = driveLegSummaries[index];
          const fallbackDirection = getCardinalDirection(routePoints[index], routePoints[index + 1]);
          const roadNumbers =
            legSummary && Array.isArray(legSummary.roads) && legSummary.roads.length
              ? legSummary.roads.join(" ‚Ä¢ ")
              : "N/A";
          const directionText =
            legSummary && typeof legSummary.direction === "string" && legSummary.direction
              ? legSummary.direction
              : fallbackDirection;

          let summaryClass = "itinerary-road-summary";
          summaryClass += " road-link";
          if (isLoading && !legSummary) {
            summaryClass += " loading";
          }
          const legDirectionsUrl = mapsDirectionsUrl(
            locations[index],
            locations[index + 1],
            routePoints[index],
            routePoints[index + 1]
          );

          html +=
            "<a class=\"" + summaryClass + "\" href=\"" + escapeHtml(legDirectionsUrl) + "\" target=\"_blank\" rel=\"noopener noreferrer\" aria-label=\"Open driving itinerary between " + escapeHtml(locations[index].name) + " and " + escapeHtml(locations[index + 1].name) + "\">" +
              "<span>üõ£Ô∏è Roads: " + escapeHtml(roadNumbers) + "</span>" +
              "<span>‚Ä¢</span>" +
              "<span>Direction: " + escapeHtml(directionText) + "</span>" +
            "</a>";

          const durationValue = getLegDurationSeconds(
            day,
            locations[index],
            locations[index + 1],
            legSummary
          );
          let durationText = "Drive time unavailable";
          let driveClass = "itinerary-drive-time";

          if (typeof durationValue === "number") {
            durationText = "Drive: " + formatDriveDuration(durationValue);
          } else if (isLoading) {
            durationText = "Looking up drive time...";
            driveClass += " loading";
          }

          html +=
            "<div class=\"" + driveClass + "\">" +
              "<span>üöó</span>" +
              "<span>" + durationText + "</span>" +
            "</div>";
        }
      });

      modalItineraryEl.innerHTML = html;
    }

    function renderRecommendations(day) {
      modalRecoEl.innerHTML = day.recommendations
        .map((rec) => {
          const recommendationUrl = getRecommendationLink(rec);
          const actionLabel = getRecommendationActionLabel(rec);
          return (
          "<article class=\"recommendation-item\">" +
            "<div class=\"recommendation-head\">" +
              "<h5>" + escapeHtml(rec.title) + "</h5>" +
              "<span class=\"recommendation-kind\">" + escapeHtml(rec.kind || "Activity") + "</span>" +
            "</div>" +
            "<p>" + escapeHtml(rec.text) + "</p>" +
            "<div class=\"recommendation-price" + (rec.priceISK === 0 ? " free" : "") + "\">" +
              "üí≥ " + escapeHtml(getRecommendationPriceText(rec)) +
            "</div>" +
            "<a class=\"recommendation-action\" href=\"" + escapeHtml(recommendationUrl) + "\" target=\"_blank\" rel=\"noopener noreferrer\">" +
              escapeHtml(actionLabel) + " ‚Üó" +
            "</a>" +
          "</article>"
        );
        })
        .join("");
    }

    function openDayFullscreen(dayNumber) {
      const day = days.find((entry) => entry.day === dayNumber);
      if (!day) {
        return;
      }
      activeFullscreenDay = day.day;
      const cachedDriveSummaries = getCachedDrivingLegDurations(day);

      const color = dayColors[(day.day - 1) % dayColors.length];
      modalHeadEl.style.setProperty("--day-color", color);
      modalHeadEl.style.background = "color-mix(in srgb, " + color + " 18%, white)";
      modalTitleEl.textContent = "Day " + day.day + ": " + day.title;
      renderFullscreenSubtitle(day, cachedDriveSummaries);

      modalMapLinkEl.href = day.mapLink;

      modalEl.classList.add("open");
      document.body.classList.add("modal-open");
      scrollPageToTop();
      if (modalBodyEl) {
        modalBodyEl.scrollTop = 0;
      }
      modalEl.scrollTop = 0;

      const colorHex = resolveDayColorHex(day.day);
      renderFullscreenMap(day, colorHex);
      renderRouteStops(day, color);
      renderDayDriveTag(day, cachedDriveSummaries);
      renderItinerary(day, color, cachedDriveSummaries, !cachedDriveSummaries.length);
      renderRecommendations(day);

      const requestId = ++driveTimesRequestId;
      fetchDrivingLegDurations(day).then((durations) => {
        if (requestId !== driveTimesRequestId || !modalEl.classList.contains("open")) {
          return;
        }
        renderFullscreenSubtitle(day, durations);
        renderDayDriveTag(day, durations);
        renderItinerary(day, color, durations, false);
      });
    }

    function closeDayFullscreen() {
      driveTimesRequestId += 1;
      activeFullscreenDay = null;
      modalEl.classList.remove("open");
      document.body.classList.remove("modal-open");
    }

    daysContainerEl.addEventListener("click", (event) => {
      const trigger = event.target.closest(".fullscreen-trigger");
      if (!trigger) {
        return;
      }
      event.preventDefault();
      event.stopPropagation();

      const dayCard = trigger.closest(".day-card");
      if (!dayCard) {
        return;
      }
      const dayNumber = Number(dayCard.dataset.day);
      openDayFullscreen(dayNumber);
    });

    closeModalBtnEl.addEventListener("click", closeDayFullscreen);

    modalEl.addEventListener("click", (event) => {
      if (event.target === modalEl) {
        closeDayFullscreen();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && modalEl.classList.contains("open")) {
        closeDayFullscreen();
      }
    });

    renderPackList();
    renderBudgetCard();
    refreshIskEurRate();
    cacheHeaderVideo();
    applyTabView("home");
    updateHeaderCompactState();

    window.addEventListener("pagehide", () => {
      if (headerVideoBlobUrl) {
        URL.revokeObjectURL(headerVideoBlobUrl);
        headerVideoBlobUrl = "";
      }
    });

    days.forEach((day) => {
      const cachedDurations = getCachedDrivingLegDurations(day);
      if (cachedDurations.length) {
        renderDayDriveTag(day, cachedDurations);
      }

      fetchDrivingLegDurations(day).then((durations) => {
        renderDayDriveTag(day, durations);
        if (modalEl.classList.contains("open") && activeFullscreenDay === day.day) {
          renderFullscreenSubtitle(day, durations);
          const color = dayColors[(day.day - 1) % dayColors.length];
          renderItinerary(day, color, durations, false);
        }
      });
    });
  </script>
</body>
</html>
